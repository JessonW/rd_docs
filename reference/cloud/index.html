<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>云端服务 - AbleCloud 开发文档</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation" style="background:#00b5f1;border:0px solid transparent;height:50px;">
    <div class="container container-ac">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../../introduction/"><img src="../../img/logo.png" /><span style="margin-left:20px; margin-right:20px;">|</span>开发文档</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse" style="margin-left:293px;">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav nav-ac">
                
                
                    <li >
                        <a href="../../introduction/" >基本介绍</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">功能说明 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../features/concepts/">基本概念</a>
</li>

                        
                            
<li >
    <a href="../../features/functions/">功能介绍</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">开发指导 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../develop_guide/android/">客户端-安卓</a>
</li>

                        
                            
<li >
    <a href="../../develop_guide/iOS/">客户端-iOS</a>
</li>

                        
                            
<li >
    <a href="../../develop_guide/wechat/">客户端-微信</a>
</li>

                        
                            
<li >
    <a href="../../develop_guide/device/">设备-嵌入式系统</a>
</li>

                        
                            
<li >
    <a href="../../develop_guide/device_android/">设备-安卓系统</a>
</li>

                        
                            
<li >
    <a href="../../develop_guide/cloud/">云端服务</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../android/">客户端-安卓</a>
</li>

                        
                            
<li >
    <a href="../iOS/">客户端-iOS</a>
</li>

                        
                            
<li >
    <a href="../wechat/">客户端-微信</a>
</li>

                        
                            
<li >
    <a href="../device/">设备-嵌入式系统</a>
</li>

                        
                            
<li >
    <a href="../device_android/">设备-安卓系统</a>
</li>

                        
                            
<li class="active">
    <a href="./">云端服务</a>
</li>

                        
                            
<li >
    <a href="../php/">PHP SDK</a>
</li>

                        
                            
<li >
    <a href="../java/">Java SDK</a>
</li>

                        
                            
<li >
    <a href="../error_code/">Error Code</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../../QandA/" >Q&A</a>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://docs.ablecloud.cn/1.0/introduction/" style="font-size:0.9em;">旧版文档</a></li>
            </ul>
        </div>

    </div>

</div>

        <div class="container container-ac">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        
        
        
        <li class="main active">
            <a href="#_1">云端服务开发参考</a>
        </li>
        
    
        
        
        
        <li class="main">
            <a href="#_2">简介</a>
        </li>
        
    
        
        
        
        <li class="main">
            <a href="#_3">服务框架发布库</a>
        </li>
        
    
        
        
            
                
            
        
            
                
            
        
        
        <li class="main">
            <a href="#_4">基础数据结构<span class="main-set parent__4">+</span></a>
        </li>
        
            
            <li class="sub parent__4" style="display: none;"><a href="#accontext">ACContext</a></li>
            
        
            
            <li class="sub parent__4" style="display: none;"><a href="#acobject">ACObject</a></li>
            
        
    
        
        
            
                
            
        
            
                
            
        
            
                
            
        
        
        <li class="main">
            <a href="#_5">交互消息<span class="main-set parent__5">+</span></a>
        </li>
        
            
            <li class="sub parent__5" style="display: none;"><a href="#acmsg">ACMsg</a></li>
            
        
            
            <li class="sub parent__5" style="display: none;"><a href="#acdevicemsg">ACDeviceMsg</a></li>
            
        
            
            <li class="sub parent__5" style="display: none;"><a href="#acdevicemsgmarshaller">ACDeviceMsgMarshaller</a></li>
            
        
    
        
        
            
                
            
        
            
                
            
        
            
                
            
        
        
        <li class="main">
            <a href="#_7">服务开发框架<span class="main-set parent__7">+</span></a>
        </li>
        
            
            <li class="sub parent__7" style="display: none;"><a href="#acserviceuds">ACService：UDS</a></li>
            
        
            
            <li class="sub parent__7" style="display: none;"><a href="#accronjob">ACCronJob：后台任务</a></li>
            
        
            
            <li class="sub parent__7" style="display: none;"><a href="#ac">AC</a></li>
            
        
    
        
        
        
        <li class="main">
            <a href="#_8">内嵌云端服务</a>
        </li>
        
    
        
        
        
        <li class="main">
            <a href="#error-code">Error Code</a>
        </li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="_1">云端服务开发参考</h1>
<h1 id="_2">简介</h1>
<p>为了快速开发和业务逻辑相关的服务端程序，提高开发者效率，提高企业产品研发/上线的效率，AbleCloud提供了统一的服务开发框架，并内嵌了一系列由AbleCloud提供的云端服务。该框架支持开发者开发可运行于AbleCloud云端的自定义后端服务（UDS：User Defined Service）以及定时任务。AbleCloud的服务框架提供了高度封装的RPC服务，client与server通信时，client只需要知道service的名字，并提供相应的访问参数即可。当前AbleCloud提供Java版本的服务编程框架。本章介绍该框架提供的API。</p>
<h1 id="_3">服务框架发布库</h1>
<p>AbleCloud一期发布Java版本服务开发框架，其发布目录、文件如下所示</p>
<pre><code>/config
    /cloudservice-conf.xml
/lib
    /ablecloud-framework-1.1.0.jar
    /ac-java-api-1.0.0.jar
    /commons-collections-3.2.1.jar
    /commons-configuration-1.10.jar
    /commons-lang-2.6.jar
    /slf4j-api-1.7.7.jar
    /...
start.sh
start.cmd
</code></pre>

<blockquote>
<p><font color=red>注意事项：</font></p>
<ol>
<li>
<p>所有依赖的第三方jar包，均放在lib文件夹下。其中包括AbleCloud的服务框架<code>ablecloud-framework-1.1.0.jar</code>和<code>ac-java-api-1.0.0.jar</code>。根据AbleCloud的发行状态，各jar包的版本号可能不同。</p>
</li>
<li>
<p>开发者开发的自定义服务也编译成jar包，并置于lib文件夹下。同时，还要在pom.xml里的<code>&lt;additionalClasspathElement&gt;</code>标签下添加测试依赖。</p>
</li>
<li>
<p>按上述目录结构将所有文件压缩、打包成一个ZIP文件（文件名可自取）。要求ZIP文件解压缩后能直接得到上述目录或文件，不能存在其它中间层次的目录。</p>
</li>
<li>
<p>在开发者管理控制台中提交压缩后的ZIP文件，之后即可通过“上线”/“下线”功能管理UDS的运行状态。</p>
</li>
</ol>
</blockquote>
<h1 id="_4">基础数据结构</h1>
<h2 id="accontext">ACContext</h2>
<p>ACContext即上下文，用于标记每一次交互（比如发起者、发起时间、签名等）、追踪通信事件。AbleCloud服务之间的交互消息中均需要带有上下文信息。
ACContext定义的内容如下：</p>
<pre><code class="java">public class ACContext {
    private String majorDomain;         // 服务所属主域ID
    private String subDomain;           // 服务所属子域ID
    private String majorDomainName;     // 服务所属主域名
    private String subDomainName;       // 服务所属子域名
    private Long userId;                // 用户id
    private Long developerId;           // 开发者id
    private String traceId;             // 唯一事件id，可用于追查问题
    private String traceStartTime;      // 起始时间
    private String timestamp;           // 请求发起的时间戳，单位秒
    private String signature;           // 请求的签名
    private String timeout;             // 为防止签名被截获，设置签名的有效超时时间
    private String nonce;               // 用于签名的随机字符串
    private String accessKey;           // 开发者的accesskey，用于签名之用
}
</code></pre>

<p>通过ACContext的定义我们可以看出，其中包含两种用户信息：</p>
<ul>
<li><strong>userId：</strong>设备的终端（普通）用户id，比如用户在手机上通过app控制某一设备时，context中需要带上该用户的id，后台用于认证等之用。当用户通过云服务发起远程控制时，云服务程序透传用户的context。使用示例：<code>ac.newContext(userId)</code></li>
<li><strong>developerId：</strong>开发者id。UDS服务一方面接收APP或设备发来的消息，另一方面可能需要自主的访问云端通用服务或执行例行巡检任务，当对AbleCloud后台服务发起请求时，context中并不会有userId等终端用户的信息，此时服务创建的context需要填充developerId的值。使用示例：<code>ac.newContext()</code></li>
</ul>
<blockquote>
<p><font color="brown"><strong>注：</strong></font>上下文context有一个重要的特性是，在其生成后的所有交互中，都不能更改其已有字段的值，可以添加还没有赋值的字段。比如有终端用户发起的请求中带有userId，请求到达云服务端时，云服务可以往该context中设置developerId的值，但不能修改其它值。否则就失去了追踪每一次交互的意义了。
开发者不应该直接用ACContext的构造函数构造上下文对象，而应使用AC框架的相关接口创建上下文对象，后面会有详细描述。</p>
</blockquote>
<h2 id="acobject">ACObject</h2>
<p>ACObject用于承载交互的具体数据，我们称之为payload（负载）。ACObject数据内部结构以HashMap来存放，通过put存入ACObject的数据内部以json方式处理，因此ACObject中的value也可以是嵌套的ACObject，能满足大部分需求场景。</p>
<pre><code class="java">public class ACObject {
    private HashMap&lt;String, Object&gt; data = new HashMap&lt;String, Object&gt;();

    /**
     * 设置一个参数
     * @param key   参数名
     * @param &lt;T&gt;   参数值
     * @return
     */
    public &lt;T&gt; ACObject put(String key, T value) {}

    /**
     * 添加一个参数，该参数添加到一个List中
     * @param key   参数所在List的名字
     * @param value 参数值
     */
    public ACObject add(String key, Object value) {}

    /**
     * 获取一个参数值
     * @param key   参数名
     * @return      参数值
     */
    public &lt;T&gt; T get(String key) {}

    /**
     * 检查某一key是否存在
     * @param key   参数名
     * @return      存在返回true，否则返回false
     */
    public boolean contains(String key) {}
}
</code></pre>

<blockquote>
<p><font color="brown"><strong>注：</strong>最常用的三个接口是put/add/get。通过<strong>add</strong>接口保存在ACObject中的数据实际为List；相应的，get出来也是一个List。</font></p>
</blockquote>
<h1 id="_5">交互消息</h1>
<p>多个模块、服务之间都通过<em>消息</em><code>message</code>来通信。AbleCloud定义了两种格式的消息：</p>
<ul>
<li><strong>ACMsg：</strong>APP与service，service与service之间的交互消息。</li>
<li><strong>ACDeviceMsg：</strong>APP与device，service与device之间的交互消息。</li>
</ul>
<h2 id="acmsg">ACMsg</h2>
<p>ACMsg继承自ACObject，扩展了一些功能，比如设置了交互的方法名name、交互的上下文context以及<strong>其它形式</strong>的负载payload信息。通常采用ACMsg进行数据交互，较多的使用默认的<strong>ACMsg.OBJECT_PAYLOAD</strong>格式，该格式只需要使用ACObject提供的put、add、get接口进行数据操作即可。因为在使用OBJECT_PAYLOAD格式时，框架会对数据进行序列化/反序列化。ACMsg也提供另外的数据交互格式，如json、stream等。如果用json格式，则通过setPayload/getPayload设置/获取序列化后的json数据并设置对应的payloadFormat，开发者后续可自行对payload进解析。</p>
<pre><code class="java">public class ACMsg extends ACObject {
    public static final String OBJECT_PAYLOAD = &quot;application/x-zc-object&quot;;
    public static final String JSON_PAYLOAD = &quot;text/json&quot;;
    public static final String STREAM_PAYLOAD = &quot;application/octet-stream&quot;;

    private String name;
    private ACContext context;
    private String payloadFormat;
    private byte[] payload;
    private int payloadSize;
    private InputStream streamPayload;

    public ACMsg() {}

    /**
     * 设置请求方法名，服务端将根据该方法名进行处理
     * @param name  方法名
     */
    public void setName(String name) {}

    /**
     * 获取方法名
     * @return
     */
    public String getName() {}

    /**
     * 获取交互上下文
     * @return
     */
    public ACContext getContext() {}

    /**
     * 设置交互上下文
     * @param context
     */
    public void setContext(ACContext context) {}

    /**
     * 获取负载格式
     * @return
     */
    public String getPayloadFormat() {}

    /**
     * 获取二进制负载
     * @return
     */
    public byte[] getPayload() {}

    /**
     * 获取负载大小
     * @return
     */
    public int getPayloadSize() {}

    /**
     * 设置二进制负载
     * 通过put/add方式设置的负载要么框架将其序列化为json，
     * 要么解析后作为url的参数传输。
     * 通过该函数可以设置额外的负载数据，比如传统的序列化后的json值。
     * @param payload
     * @param format
     */
    public void setPayload(byte[] payload, String format) {}

    /**
     * 设置流式负载，主要用于较大的数据传输，如上传文件等。
     * @param payload   负载内容
     * @param size      负载大小
     */
    public void setStreamPayload(InputStream payload, int size) {}

    /**
     * 获取流式负载
     * @return
     */
    public InputStream getStreamPayload() {}

    /**
     * 关闭流式负载。
     * 通过getStreamPayload拿到流式负载后，需要显示的关闭。
     * @throws IOException
     */
    public void closeStreamPayload() throws IOException {}

    /**
     * 设置错误信息。在服务端处理错误时，需要显示的调用该结果设置错误信息
     * @param errCode   错误码
     * @param errMsg    错误信息
     */
    public void setErr(Integer errCode, String errMsg) {}

    /**
     * 判断服务端响应的处理结果
     * @return  true-处理出错，false-处理成功
     */
    public boolean isErr() {}

    /**
     * 获取错误码
     * @return
     */
    public Integer getErrCode() {}

    /**
     * 获取错误信息
     * @return
     */
    public String getErrMsg() {}

    /**
     * 服务端处理成功后，调用该方法
     */
    public void setAck() {}
}
</code></pre>

<blockquote>
<p><font color="red"><strong>注：</strong></font>开发者在本地测试或联调时，需要设置context的相关信息。客户端往后端服务发送消息，服务向另一服务发送消息的时候，均需要对所发请求进行签名，具体的签名算法见附录。</p>
</blockquote>
<h3 id="_6">使用示例</h3>
<p>client端发起请求（伪代码，完整代码请参看各部分demo）：</p>
<pre><code class="java">ACContext context = ac.newContext(account.getUid());    // 通过框架构造一个用户context
ACMsg req = new ACMsg();                                // 创建一个空请求消息
req.setContext(context);                                // 设置请求上下文
req.setName(&quot;controlLight&quot;);                            // 设置请求消息名
req.put(&quot;deviceId&quot;, light.getId());                     // 设置一个请求属性“设备id”
req.put(&quot;action&quot;, &quot;on&quot;);                                // 设置另一属性&quot;动作“，开灯
ACMsg resp = client.send(req);                          // 发送请求并返回服务端响应
</code></pre>

<p>服务端处理请求（伪代码，完整代码请参看各部分demo）：</p>
<pre><code>private void handleControlLight(ACMsg req, ACMsg resp) throws Exception {
    Long lightId = req.get(&quot;deviceId&quot;);     // 从请求中获取“设备id”
    String action = req.get(&quot;action&quot;);      // 从请求中获取“动作”
    // do something
}
</code></pre>

<h2 id="acdevicemsg">ACDeviceMsg</h2>
<p>该消息用于处理服务和设备之间的交互，框架会将ACDeviceMsg中的code部分解析出来，开发者可根据code来区分设备消息类型。并根据code的不同值执行不同的序列化/反序列化操作。</p>
<blockquote>
<ul>
<li><strong>二进制/json</strong>
在使用二进制或json格式通讯协议的情况下,ACDeviceMsg的content部分由开发者解释，框架透传，因此开发者需要自己编写设备消息序列化/反序列化器。</li>
<li><strong>KLV</strong>
KLV是由AbleCloud规定的一种数据格式，即可以理解为content部分的一种特殊格式。具体应用时，需要到AbleCloud平台定义设备的数据点和数据包。此时开发者不需要自己编写消息序列化/反序列化器，AbleCloud可依据定义的数据点和数据包自动解析消息的内容。</li>
</ul>
</blockquote>
<p>ACDeviceMsg定义如下：</p>
<pre><code class="java">public class ACDeviceMsg {
    private int code;           // 消息码，用于区分消息类型
    private Object content;     // 设备消息的具体内容

    public ACDeviceMsg() {}
    public ACDeviceMsg(int code, Object content) {}
    public int getCode() {}
    public void setCode(int code) {}
    public Object getContent() {}
    public void setContent(Object content) {}
    public void setKLVObject(ACKLVObject object) {}
    public ACKLVObject getKLVObject() {}
}
</code></pre>

<p><font color=red>注意</font>：从上面的定义可以看到，设备消息的具体内容为Object类型。开发者需要根据实际情况实现序列化器用来解释content的内容。</p>
<h2 id="acdevicemsgmarshaller">ACDeviceMsgMarshaller</h2>
<p>设备消息的序列化/反序列化器，用于解释ACDeviceMsg的具体内容。其定义如下：</p>
<pre><code class="java">public interface ACDeviceMsgMarshaller {
    /**
     * 将具体的ACDeviceMsg序列化成字节数组，用于控制设备时通过网络下发****给设备
     *
     * @param msg       设备消息
     * @return          序列化后的字节数组
     * @throws Exception
     */
    public byte[] marshal(ACDeviceMsg msg) throws Exception;

    /**
     * 将通过网络收到的字节数组数据，反序列化成具体的消息，以便从消息中提取各个字段。
     *
     * @param msgCode   消息码
     * @param payload   设备消息序列化后的字节数组
     * @return          设备消息
     * @throws Exception
     */
    public ACDeviceMsg unmarshal(int msgCode, byte[] payload) throws Exception;
}
</code></pre>

<p>开发者应该在其重载的ACService.init()方法中初始化设备消息的序列化/反序列化器，并将其配置给服务开发框架。
当UDS向设备发送消息时，开发框架会自动调用该序列化/反序列化器的marshal方法将数据序列化为设备可理解的数据，之后再通过AbleCloud云端服务传输给设备。
当UDS接收到设备上报的消息时，开发框架会自动调用该序列化/反序列化器的unmarshal方法依据设备上报的消息创建ACDeviceMsg对象，并以该ACDeviceMsg对象为参数调用开发者重载的ACService.handleDeviceMsg()方法。</p>
<h1 id="_7">服务开发框架</h1>
<p>开发者在使用AbleCloud框架开发服务时，仅需简单的使用前文介绍的基础数据结构，将精力集中在实现应用的业务逻辑上，快速完成服务程序的开发/测试/发布。</p>
<h2 id="acserviceuds">ACService：UDS</h2>
<p>AbleCloud定义了抽象基类ACService，开发者只需要继承该类，并实现各个handler即可。定义如下:</p>
<pre><code class="java">public abstract class ACService {
    // 开发者可以调用ac的相关接口直接调用AbleCloud提供的云服务。
    protected AC ac;

    // 以下信息可用于服务内部追踪问题等用，比如打印到日志中
    protected long developerId;         // 开发者id
    protected String majorDomain;       // 服务的主域名
    protected String subDomain;         // 服务的子域名
    protected int majorVersion;         // 服务的主版本号
    protected int minorVersion;         // 服务的副版本号
    protected int patchVersion;         // 服务的修订版本号

    /**
     * 开发者可根据自身需要，重载该方法，在该方法里做一些初始化工作，框架在启动服务时会调用该函数。
     * 比如，该服务要处理和设备之间的交互消息，需要自定义设备消息的序列化/反序列化器
     * ACDeviceMsgMarshaller，在init函数内将marshaller设置到ac中。
     *
     * @throws Exception
     */
    public void init() throws Exception {}

    /**
     * 处理APP--&gt;Service，Service--&gt;Service之间的交互消息
     * @param req   请求消息体
     * @param resp  响应消息体
     * @throws Exception
     */
    public abstract void handleMsg(ACMsg req, ACMsg resp) throws Exception;

    /**
     * 处理Device--&gt;Service之间的交互消息
     * 如果服务不处理和设备之间的交互消息，则无须重载该方法。
     *
     * 当前，处理设备汇报的消息不做响应。
     *
     * @param context       设备的上下文，其中uid字段为系统填充
     * @param deviceId      设备的逻辑id
     * @param req           请求消息体
     * @throws Exception
     */
    public abstract void handleDeviceMsg(ACContext context, long deviceId, ACDeviceMsg req) throws Exception;

    /**
     * 处理JINDDONG--&gt;Service之间的交互消息，收到Stream点数组，进行设备控制
     *
     * @param context          设备的上下文，其中uid字段为系统填充
     * @param physicalDeviceId 设备的物理id
     * @param req              请求消息体(Stream数组)
     * @param resp             响应消息体
     * @throws Exception
     */
    public void handleJDSetStatusMsg(ACContext context, String physicalDeviceId, List&lt;ACJDMsg&gt; req, ACMsg resp) throws Exception {}

    /**
     * 处理JINDDONG--&gt;Service之间的交互消息,获取设备上所有Stream点
     *
     * @param context          设备的上下文，其中uid字段为系统填充
     * @param physicalDeviceId 设备的物理id
     * @param resp             响应消息体(Stream数组)
     * @throws Exception
     */
    public void handleJDGetStatusMsg(ACContext context, String physicalDeviceId, List&lt;ACJDMsg&gt; resp) throws Exception {}

    /**
     * 处理SUNING--&gt;Service之间的交互消息，收到Stream点数组，进行设备控制
     *
     * @param physicalDeviceId 设备的物理id
     * @param req              请求消息体(Stream数组)
     * @param resp             响应消息体
     * @throws Exception
     */
    public void handleSNSetStatusMsg(ACContext context, String physicalDeviceId, List&lt;ACSNMsg&gt; req, ACMsg resp) throws Exception {
    }

    /**
     * 处理SUNING--&gt;Service之间的交互消息,获取设备上所有Stream点
     *
     * @param physicalDeviceId 设备的物理id
     * @param resp             响应消息体(Stream数组)
     * @throws Exception
     */
    public void handleSNGetStatusMsg(ACContext context, String physicalDeviceId, List&lt;ACSNMsg&gt; resp) throws Exception {
    }

    /**
     * 处理设备强制解绑的消息（不需要调解绑接口，此时不能与设备进行交互）
     * 如果除了解绑设备之外没有任何其他的处理逻辑，则无需继承此方法
     *
     * @param context          设备的上下文，其中uid字段为系统填充
     * @param physicalDeviceId 设备的物理id
     */
    public void handleDeviceForceUnbind(ACContext context, String physicalDeviceId, ACMsg resp) throws Exception {
    }

    /**
     * 内部调用接口，开发者不用关注且不能修改。
     * 设置服务相关的信息，并将全局AC框架传给服务
     * 服务内部可以使用AC框架提供的各种功能，如
     * 帐号管理、设备管理、存储服务等。
     * @param ac
     * @param config
     */
    public final void setEnv(AC ac, ACConfiguration config) {}

    /**
     * 内部调用接口，开发者不用关注且不能修改。
     * @return
     */
    public final AC getAc() {}
}
</code></pre>

<p>在上述抽象类中，对开发者来说，总共有七个公共接口，其中init提供了默认实现。如果开发者实现的某一服务不需要和设备直接交互，则直接重载handleDeviceMsg为空实现即可。通常情况下，init只需要设置设备消息处理的序列化器即可。因此，开发者可以将精力集中在handleMsg接口的实现中，该接口处理客户端请求，并作出响应。下文会对该抽象类进行详细介绍。</p>
<blockquote>
<p><font color="red"><strong>注：</strong></font>通常情况下，开发者只需要重点实现<strong>handleMsg</strong>即可。当然如果需要处理复杂的设备上报数据，则还需要重点实现<strong>handleDeviceMsg</strong>并根据不同code做不同处理 。</p>
</blockquote>
<h2 id="accronjob">ACCronJob：后台任务</h2>
<h3 id="accronjob_1">ACCronJob</h3>
<p>AbleCloud定义了云端定时任务的抽象基类ACCronJob。开发者需要继承该类，并实现其定义的抽象方法ACCronJob::run，即能完成定时任务的开发。ACCronJob的定义如下：</p>
<pre><code class="java">public abstract class ACCronJob {
    // 开发者可以调用ac的相关接口直接调用AbleCloud提供的云服务。
    protected AC ac;

    // 以下信息可用于任务内部追踪问题等用，比如打印到日志中等。
    protected long developerId;         // 开发者id
    protected String majorDomain;       // 服务的主域名
    protected String subDomain;         // 服务的子域名
    protected int majorVersion;         // 服务的主版本号
    protected int minorVersion;         // 服务的副版本号
    protected int patchVersion;         // 服务的修订版本号

    /**
     * 内部调用接口，开发者不用关注且不能修改。
     * 设置服务相关的信息，并将全局AC框架传给服务。服务内部可以使用AC框架提供的各种功能，如帐号管理、设备管理、存储服务等。
     * @param ac
     * @param config
     */
    public final void setEnv(AC ac, ACConfiguration config) {
        this.ac = ac;
        this.developerId = config.getDeveloperId();
        this.majorDomain = config.getServiceMajorDomain();
        this.subDomain = config.getServiceSubDomain();
        this.majorVersion = config.getServiceMajorVersion();
        this.minorVersion = config.getServiceMinorVersion();
        this.patchVersion = config.getServicePatchVersion();
    }

    /**
     * 用于获取AC框架。
     * @return AC对象。
     */
    public final AC getAc() {
        return ac;
    }

    /**
     * 定时任务的执行函数。
     * @return 返回任务的结束后，进程退出时所使用的状态码。
     * @throws Exception
     */
    public abstract int run() throws Exception;
}
</code></pre>

<p>上述抽象类共定义了三个公共方法：ACCronJob::setEnv，ACCronJob::getAC，以及ACCronJob::run。其中，ACCronJob::run是定时任务的执行函数，要求开发者提供具体实现。</p>
<h3 id="crontab">Crontab</h3>
<p>Crontab定时规则由五部分组成，由左至右分别表示分、时、日、月、周。每个部分之间以空格字符分隔。如“30 12 * * *”表示“每天的12:30”。其中，第一个部分的“30”表示30分，第二个部分的“12”表示12点，后面三个部分的“*”分别表示每天、每月及一星期内的每一天。
规则中各部分的取值范围如下（参考http://linux.vbird.org/linux_basic/0430cron.php）：</p>
<table>
<thead>
<tr>
<th>代表意义</th>
<th>分钟</th>
<th>小时</th>
<th>日期</th>
<th>月份</th>
<th>周</th>
</tr>
</thead>
<tbody>
<tr>
<td>数字范围</td>
<td>0-59</td>
<td>0-23</td>
<td>1-31</td>
<td>1-12</td>
<td>0-7</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>其中，“周”的取值为0或7时都表示“星期天”。除此之外，还有如下辅助字符可用于定义时间规则。</p>
<table>
<thead>
<tr>
<th>辅助字符</th>
<th>代表意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>*（星号）</td>
<td>代表任何时刻。例如“30 12 * * *”中日、月、周都是*， 表示“不论何月、何日、星期几的 12:30”。</td>
</tr>
<tr>
<td>,（英文逗号）</td>
<td>用于指定确定的多个值。如果要定义“每天的3:10及6:10”可使用如下规则：“10 3,6 * * *”。</td>
</tr>
<tr>
<td>-（连字符）</td>
<td>用于指定时间范围。如果定义“每天的8点至12点之间每小时的20分钟”可使用如下规则：“20 8-12 * * *”。</td>
</tr>
<tr>
<td>/n（斜杠后跟数字）</td>
<td>表示每个n个单位。例如定义“每5分钟”时可使用如下规则：“*/5 * * * *”。</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="ac">AC</h2>
<p>在介绍ACService和ACCronJob的时候提到过重要的成员变量ac，ac实际上是AbleCloud对抽象服务框架AC的具体实现，其实现过程对开发者透明。通过AC，开发者可以根据需要获取一系列内嵌服务的功能接口。AC的定义如下：</p>
<pre><code class="java">public abstract class AC {
    protected ACConfiguration config;
    protected ACDeviceMsgMarshaller deviceMsgMarshaller;

    /**
     * 构建一个开发者上下文
     * @return
     */
    public ACContext newContext() {}

    /**
     * 构建一个用户上下文，由于是框架创建的，因此也会带着开发者信息，一般用于单测
     * @param userId
     * @return
     */
    public ACContext newContext(long userId) {}

    /**
     * 构建一个用于数据查询的过滤器
     *
     * @return
     */
    public ACFilter filter(){}

    /**
     * 用于对数据分类进行具体的操作，如create/find/delete/update/scan等
     *
     * @param className     要操作的分类名
     * @param context       要进行操作的开发者context
     * @return
     */
    public abstract ACStore store(String className, ACContext context);

    /**
     * 则用于创建数据分类/清空数据等操作。
     * 用于测试之用。
     *
     * @return
     */
    public abstract ACStoreForTest storeForTest(ACContext context);

    /**
     * 往某一服务发送命令/消息
     *
     * @param subDomain 该服务所在产品名
     * @param name      服务名
     * @param version   服务版本
     * @param req       具体的消息内容，此处req无需构造ACContext
     * @return 服务端相应的消息
     * @throws Exception
     */
    public abstract ACMsg sendToService(String subDomain, String name, int version, ACMsg req) throws Exception;

    /**
     * 往JD service发送命令/消息,上报设备上的所有Stream点到JINGDONG Service
     *
     * @param context          设备的上下文，其中uid字段为系统填充
     * @param physicalDeviceId 设备的物理id
     * @param req              请求消息体(Stream数组)
     * @return 服务端相应的消息
     * @throws Exception
     */
    public abstract ACMsg sendToJDService(ACContext context, String physicalDeviceId, List&lt;ACJDMsg&gt; req) throws Exception;

    /**
     * 由于uds本身无法访问正常的外网服务，所以AbleCloud内部实现了正向代理，并提供ACHttpClient访问外网服务
     *
     * @param url 访问外网的url
     * @return ACHttpClient
     * @throws IOException
     */
    public abstract ACHttpClient getHttpClient(String url) throws IOException;

    /**
     * 获取帐号管理器。开发者组实现自定义服务时，
     * 可以调用ACAccountMgr提供的各个通用接口
     *
     * @param context   开发者的context
     * @return
     */
    public abstract ACAccountMgr accountMgr(ACContext context);

    /**
     * 获取用于单元测试的帐号管理器，可以注册用户等
     *
     * @param context   开发者的context
     * @return
     */
    public abstract ACAccountMgrForTest accountMgrForTest(ACContext context);

    /**
     * 获取设备绑定管理器。开发者在实现自定义服务时，
     * 可以调用ACBindMgr提供的各个通用接口
     *
     * @param context 用户的context
     * @return
     */
    public abstract ACBindMgr bindMgr(ACContext context);

    /**
     * 获取用于单元测试的设备绑定管理器，可以绑定/解绑设备等
     *
     * @param context 用户的context
     * @return
     */
    public abstract ACBindMgrForTest bindMgrForTest(ACContext context);

    /**
     * 获取推送通知管理器，可以给用户发送通知消息
     *
     * @param context   开发者的context
     * @return
     */
    public abstract ACNotificationMgr notificationMgr(ACContext context);

    /**
     * 获取用于单元测试的推送通知管理器
     *
     * @param context 开发者的context
     * @return
     */
    public abstract ACNotificationMgrForTest notificationMgrForTest(ACContext context);

    /**
     * 获取定时管理器，可以定时给设备发送消息
     *
     * @param context 开发者的context
     * @return
     */
    public abstract ACTimerTaskMgr timerTaskMgr(ACContext context);

    /**
     * 获取用于单元测试的定时管理器
     *
     * @param context 开发者的context
     * @return
     */
    public abstract ACTimerTaskMgrForTest timerTaskMgrForTest(ACContext context);

    /**
     * 为便于测试，开发者可实现一个服务的桩
     * 在框架中添加一个服务桩，即mock
     *
     * @param name  服务名
     * @param stub  服务桩的实现，实际上也是一个ACService
     */
    public abstract void addServiceStub(String name, ACService stub);

    /**
     * 为便于测试，开发者可实现一个设备的桩
     *
     * @param subDomain     设备所属子域
     * @param stub          设备桩
     */
    public abstract void addDeviceStub(String subDomain, ACDeviceStub stub);

    /**
     * 如果服务要处理和设备之间的交互消息，需要实现设备消息序列化/反序列化器
     * 该接口将序列化/反序列化器设置给ac框架
     *
     * @param marshaller    设备消息序列化/反序列化器
     */
    public void setDeviceMsgMarshaller(ACDeviceMsgMarshaller marshaller) {}

    /**
     * 获取设备消息序列化/反序列化器
     * @return
     */
    public ACDeviceMsgMarshaller getDeviceMsgMarshaller() {}

    /**
     * 获取用于单元测试的服务框架ac
     * @param config    单元测试环境构造的config
     * @return
     * @throws Exception
     */
    public static final AC getTestAc(ACConfiguration config) throws Exception {}
}
</code></pre>

<blockquote>
<p><font color=red>注意</font>：由于开发者具有超级权限，所以AbleCloud除了提供正常的服务管理器接口外，还提供一些用于单元测试的管理器接口，如<code>ac.accountMgrForTest(ac.newContext())</code></p>
</blockquote>
<h1 id="_8">内嵌云端服务</h1>
<p>顾名思义，内嵌云端服务，是指AbleCloud抽象并实现的多种通用后端服务，避免开发者重复开发这些基础设施。开发者可直接使用这些服务，降低应用服务程序的开发代价，提高开发效率。各个云端服务的对象可通过上节介绍的服务框架AC的相关接口获取。</p>
<p>API说明请参考<a href="../java/">Java SDK开发参考</a>。</p>
<h1 id="error-code">Error Code</h1>
<p>参考<a href="../error_code/">Reference-Error Code</a>。</p></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <div class="clear footer">
                &copy;2015&nbsp;&nbsp;北京智云奇点科技有限公司&nbsp;&nbsp;<a href="http://www.miit.gov.cn/" target="_blank">京ICP备14010946号-1</a>
            </div>
        </footer>

        <script type="text/javascript" src="../../js/jquery-1.10.2.min.js"></script>
        <script type="text/javascript" src="../../js/bootstrap.min.js"></script>
        <script type="text/javascript" src="../../js/highlight.pack.js"></script>
        <script type="text/javascript" src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
