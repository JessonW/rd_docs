<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>客户端-iOS - AbleCloud 开发文档</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation" style="background:#00b5f1;border:0px solid transparent;height:50px;">
    <div class="container container-ac">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../../introduction/"><img src="../../img/logo.png" /><span style="margin-left:20px; margin-right:20px;">|</span>开发文档</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse" style="margin-left:293px;">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav nav-ac">
                
                
                    <li >
                        <a href="../../introduction/" >基本介绍</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">功能说明 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../features/concepts/">基本概念</a>
</li>

                        
                            
<li >
    <a href="../../features/functions/">功能介绍</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">开发指导 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../android/">客户端-安卓</a>
</li>

                        
                            
<li class="active">
    <a href="./">客户端-iOS</a>
</li>

                        
                            
<li >
    <a href="../wechat/">客户端-微信</a>
</li>

                        
                            
<li >
    <a href="../device/">设备-嵌入式系统</a>
</li>

                        
                            
<li >
    <a href="../device_android/">设备-安卓系统</a>
</li>

                        
                            
<li >
    <a href="../cloud/">云端服务</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../reference/android/">客户端-安卓</a>
</li>

                        
                            
<li >
    <a href="../../reference/iOS/">客户端-iOS</a>
</li>

                        
                            
<li >
    <a href="../../reference/wechat/">客户端-微信</a>
</li>

                        
                            
<li >
    <a href="../../reference/device/">设备-嵌入式系统</a>
</li>

                        
                            
<li >
    <a href="../../reference/device_android/">设备-安卓系统</a>
</li>

                        
                            
<li >
    <a href="../../reference/cloud/">云端服务</a>
</li>

                        
                            
<li >
    <a href="../../reference/error_code/">Error Code</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../../QandA/" >Q&A</a>
                    </li>
                
                
                </ul>
            
        </div>
    </div>
</div>

        <div class="container container-ac">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        
        
            
                
            
        
        
        <li class="main active">
            <a href="#ios">IOS客户端开发指导<span class="main-set parent_ios">+</span></a>
        </li>
        
            
            <li class="sub parent_ios" style="display: none;"><a href="#_1">开发环境设置</a></li>
            
        
    
        
        
            
                
            
        
            
                
            
        
            
                
            
        
            
                
            
        
            
                
            
        
            
                
            
        
        
        <li class="main">
            <a href="#_3">帐号管理<span class="main-set parent__3">+</span></a>
        </li>
        
            
            <li class="sub parent__3" style="display: none;"><a href="#_4">接口说明</a></li>
            
        
            
            <li class="sub parent__3" style="display: none;"><a href="#_5">引入头文件</a></li>
            
        
            
            <li class="sub parent__3" style="display: none;"><a href="#_6">账号管理类</a></li>
            
        
            
            <li class="sub parent__3" style="display: none;"><a href="#_7">普通帐号注册流程</a></li>
            
        
            
            <li class="sub parent__3" style="display: none;"><a href="#_8">二、第三方登录</a></li>
            
        
            
            <li class="sub parent__3" style="display: none;"><a href="#_9">三、添加帐号扩展属性</a></li>
            
        
    
        
        
            
                
            
        
            
                
            
        
            
                
            
        
        
        <li class="main">
            <a href="#_10">设备管理<span class="main-set parent__10">+</span></a>
        </li>
        
            
            <li class="sub parent__10" style="display: none;"><a href="#_11">独立设备</a></li>
            
        
            
            <li class="sub parent__10" style="display: none;"><a href="#_15">网关型设备</a></li>
            
        
            
            <li class="sub parent__10" style="display: none;"><a href="#_19">设备扩展属性</a></li>
            
        
    
        
        
            
                
            
        
            
                
            
        
            
                
            
        
        
        <li class="main">
            <a href="#_22">和云端通信<span class="main-set parent__22">+</span></a>
        </li>
        
            
            <li class="sub parent__22" style="display: none;"><a href="#_23">一、发送消息到设备</a></li>
            
        
            
            <li class="sub parent__22" style="display: none;"><a href="#_25">二、发送消息到服务</a></li>
            
        
            
            <li class="sub parent__22" style="display: none;"><a href="#_26">三、实时消息</a></li>
            
        
    
        
        
        
        <li class="main">
            <a href="#_27">局域网通信</a>
        </li>
        
    
        
        
            
        
        
        <li class="main">
            <a href="#_28">定时任务</a>
        </li>
        
            
        
    
        
        
            
        
        
        <li class="main">
            <a href="#ota">OTA</a>
        </li>
        
            
        
    
        
        
            
                
            
        
            
                
            
        
            
                
            
        
        
        <li class="main">
            <a href="#_38">推送<span class="main-set parent__38">+</span></a>
        </li>
        
            
            <li class="sub parent__38" style="display: none;"><a href="#_39">推送开发准备</a></li>
            
        
            
            <li class="sub parent__38" style="display: none;"><a href="#_40">一、推送准备</a></li>
            
        
            
            <li class="sub parent__38" style="display: none;"><a href="#_41">二、开启推送服务</a></li>
            
        
    
        
        
            
                
            
        
            
                
            
        
            
                
            
        
        
        <li class="main">
            <a href="#_42">文件存储<span class="main-set parent__42">+</span></a>
        </li>
        
            
            <li class="sub parent__42" style="display: none;"><a href="#_43">一、获取文件管理器</a></li>
            
        
            
            <li class="sub parent__42" style="display: none;"><a href="#_44">二、下载文件</a></li>
            
        
            
            <li class="sub parent__42" style="display: none;"><a href="#_45">三、上传文件</a></li>
            
        
    
        
        
        
        <li class="main">
            <a href="#error-code">Error Code</a>
        </li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="ios">IOS客户端开发指导</h1>
<h3 id="_1">开发环境设置</h3>
<h4 id="_2">系统准备</h4>
<p>在进行开发前，需要对系统以及环境进行设置。目前框架支持Objective-C、C语言，因此系统准备基本都是和iOS开发相关，如Mac OS X、Xcode等。
+ <strong>OS X</strong>
系统建议采用Mac OS X 10.8以上的版本
+ <strong>Xcode</strong>
安装Xcode，建议采用6.0以上版本
+ <strong>ablecloud</strong>
下载ablecloud开发框架并解压</p>
<h4 id="xcode">Xcode</h4>
<ol>
<li><strong>新建工程</strong>
选择新建iOS Application，根据需要选择，建议选择Single View Application。
点击<strong>Next</strong>进入下一个页面，根据情况填写Product Name/Organization Name/Organization Identifier等信息。
填好后点击<strong>Next</strong>，进入下一步，填写好存放路径。
至此，新建工程完成。</li>
<li><strong>导入AbleCloudLib</strong>
按照步骤1完成了工程的新建，接下来需要将AbleCloudLib导入到工程中。
右键点击工程中想要导入的Group选择 <strong>Add Files to "your project name"...</strong>
选择AbleCloudLib的路径，勾选<strong>Copy items if needed</strong>，点击<strong>Add</strong>添加。
完成上述步骤后，我们将在工程视图里面看到该目录。
至此，开发者开发服务所以来的ablecloud开发框架库添加成功。</li>
<li><strong>本地运行</strong>
Xcode下直接<strong>Command + R</strong>运行。<blockquote>
<p><font color="brown"><strong>注：</strong></font>如果是模拟器运行请导入模拟器的静态库，如果是真机运行则导入真机静态库，否则在编译的过程中会失败。</p>
</blockquote>
</li>
</ol>
<h1 id="_3">帐号管理</h1>
<p>该服务用于管理和某一智能设备相关的用户，比如查看用户的基本信息/状态等。发现异常用户时，服务程序能及时做出相应操作。</p>
<h4 id="_4">接口说明</h4>
<h4 id="_5">引入头文件</h4>
<pre><code class="objectivec">import &quot;ACAccountManager.h&quot;
</code></pre>

<h3 id="_6">账号管理类</h3>
<pre><code class="objectivec">@interface ACAccountManager : NSObject
</code></pre>

<h3 id="_7">普通帐号注册流程</h3>
<h4 id="1">1、检查手机号是否已注册</h4>
<pre><code class="objectivec">[ACAccountManager checkExist:phoneNum callback:^(BOOL exist, NSError *error) {
     if(error){
      //返回失败信息，根据error做不同的提示或者处理}else{
         if (exist) {
         //提示手机号已经存在
         }else{
         //发送验证码
         }
      }
}];
</code></pre>

<h4 id="2">2、发送验证码</h4>
<p>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</p>
<pre><code class="c">//1代表Ablecloud短信内容的模版，具体开发需要先把短信内容模版提交到Ablecloud再获取对应的参数
=======
```objectivec
&gt;&gt;&gt;&gt;&gt;&gt;&gt; d84050087dcaf994eb56b5c637ee8e4eaf37daef
[ACAccountManager sendVerifyCodeWithAccount:phoneNum template:1 callback:^(NSError *error) {

         if (error == nil) {
             //校验验证码
         }else{
            //获取失败，根据error做不同的提示或者处理
         }

}];
</code></pre>

<h4 id="3">3、检测验证码正确性</h4>
<p>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</p>
<pre><code class="c">//phone和email可任选其一
=======
```objectivec
&gt;&gt;&gt;&gt;&gt;&gt;&gt; d84050087dcaf994eb56b5c637ee8e4eaf37daef
[ACAccountManager checkVerifyCodeWithAccount:phoneNum verifyCode:verifyCode callback:^(BOOL valid, NSError *error) {
           if(error){
            //返回失败信息，根据error做不同的提示或者处理
           }else{
                if (valid) {
                    //注册
                }else{
                //提示验证码错误
                }
            }
}];

</code></pre>

<h4 id="4">4、注册</h4>
<pre><code class="objectivec">[ACAccountManager registerWithNickName:userName phone:self.phoneNum email:nil password:passwd verifyCode:self.verifyCode callback:^(ACUserInfo *user, NSError *error) {

          if (error == nil) {
           //获得用户user.userId和user.nickName，进入主页或设备管理
          }else {
          //用户不合法
          }
}];

</code></pre>

<h2 id="_8">二、第三方登录</h2>
<p><img alt="account_Oauth" src="../../pic/develop_guide/account_Oauth.png" /></p>
<h4 id="1_1">1、直接使用第三方登录</h4>
<pre><code class="objectivec">[ACAccountManager registerWithNickName:userName phone:phone email:nil password:pwd verifyCode:verify callback:^(ACUserInfo *user, NSError *error) {
             if(error){
             //返回失败信息，根据error做不同的提示或者处理
             }else{
             //获得用户user.userId和user.nickName，进入主页或设备管理
             }
}];

[ACAccountManager registerWithNickName:userName phone:self.phoneNum email:nil password:passwd verifyCode:self.verifyCode callback:^(ACUserInfo *user, NSError *error)
{
             if(error){
             //返回失败信息，根据error做不同的提示或者处理
             }else{
             //根据获得的user，得到基本信息
             }
}];

</code></pre>

<h4 id="2_1">2、在已有普通账号登录时绑定第三方账号</h4>
<pre><code class="objectivec">[ACAccountManager registerWithNickName:userName phone:self.phoneNum email:nil password:passwd verifyCode:self.verifyCode callback:^(ACUserInfo *user, NSError *error)
{
           if(error){
           //返回失败信息，根据error做不同的提示或者处理
            }else{
            //绑定成功
            }
}];
</code></pre>

<h2 id="_9">三、添加帐号扩展属性</h2>
<p>使用账号扩展属性需要先到AbleCloud官网平台上的用户管理添加扩展属性</p>
<h4 id="1_2">1、使用类</h4>
<pre><code class="objectivec">@interface ACAccountManager : NSObject
</code></pre>

<h4 id="2_2">2、设置用户自定义扩展属性</h4>
<pre><code class="objectivec">/**
* 修改帐号扩展属性
*注意此处put进去的key与value类型需要跟平台添加的附加属  性一致
*如：ACObject * profile = [[ACObject alloc]init];
*[profile putValue:@&quot;a&quot; forKey:@&quot;北京&quot;];
*[profile putValue:@&quot;b&quot; forKey:@&quot;生日&quot;];
*/

[ACAccountManager setUserProfile:acObj callback:^(NSError *error) {
            if(error){
             //返回失败信息，根据error做不同的提示或者处理
             }else{
            //修改成功
             }   
}];
</code></pre>

<h4 id="3_1">3、获取用户自定义扩展属性</h4>
<pre><code class="objectivec">[ACAccountManager getUserProfile:^(ACObject *profile, NSError *error)
{ 
             if(error){
            //返回失败信息，根据error做不同的提示或者处理
             }else{
            //获取成功
              } 
}
</code></pre>

<h1 id="_10">设备管理</h1>
<h2 id="_11">独立设备</h2>
<p>功能介绍参见 <a href="../../features/functions/#_3">功能说明-功能介绍-独立设备管理</a></p>
<p><strong>用户登录/注册后，需要绑定设备才能够使用。对于wifi设备，绑定设备时，首先需在APP上给出配置设备进入Smartconfig状态的提示；然后填写当前手机连接的WiFi的密码，调用startAbleLink将WiFi密码广播给设备，设备拿到WiFi密码后连接到云端然后开始局域网广播自己的物理Id和subdomainID，APP拿到这些信息后调用bindDevice接口绑定设备。对于GPRS设备，则无需以上设备激活的流程，通过扫码或其他方式获取物理Id后调用bindDevice进行绑定。</strong></p>
<p><img alt="DM_wifi" src="../../pic/develop_guide/DM_WiFi.png" /></p>
<h3 id="_12">一．绑定设备</h3>
<h3 id="wifi">WiFi设备</h3>
<h4 id="1acwifilinkmanager">1.ACWifiLinkManager类</h4>
<p>Ablecloud提供了ACWifiLinkManager类激活器供你使用</p>
<pre><code class="objectivec">
@interface ACWifiLinkManager : NSObject

- (id)initWithLinkerName:(NSString *)linkerName;
</code></pre>

<blockquote>
<p><font color="red">注</font>：linkerName表示开发板型号，如果用的是其它的开发板，则需要改成相对应的值。
目前支持的开发板有<code>smartlink</code>、<code>oneshot</code>、<code>easyconfig</code>、<code>easylink</code>、<code>smartconfig</code>。</p>
</blockquote>
<h4 id="2wifi-ssid">2.获取WiFi SSID</h4>
<pre><code class="objectivec">NSString * ssid = [ACWifilinkManager getCurrentSSID];
</code></pre>

<h4 id="3_2">3.激活设备</h4>
<p>APP通过startAbleLink广播自己的WiFi密码，设备成功连上云之后通过广播通知APP同时获取设备物理Id和subDomainId（用来区分设备类型）。当前只支持配置手机当前连接的WiFi。</p>
<pre><code class="objectivec">[wifiManager sendWifiInfo:ssid password:pwd timeout:timeout callback:^(NSArray *localDevices, NSError *error) {
        if(error){
        //返回失败信息，根据error做不同的提示或者处理，此处一般为1993配置超时错误
        }else{
        //成功后得到已激活设备的列表，从列表中得到物理id后进行绑定
        }  
}];
</code></pre>

<p>设备无法激活时，请检查以下问题：</p>
<ul>
<li>1.确认WIFI密码是否输入正确。</li>
<li>2.确认路由器的广播功能有没有被禁用。</li>
<li>3.设备的秘钥可能存在问题。</li>
</ul>
<h4 id="4_1">4.绑定设备</h4>
<p>通过获取到的subdomainID匹配subdomian，然后在成功激活设备后的回调方法中，通过subdomian和物理Id绑定设备。</p>
<pre><code class="objectivec">[ACBindManager bindDeviceWithSubDomain:subdomain physicalDeviceId:tmpdevice.deviceId
name:[deviceNames objectAtIndex:i] callback:^(ACUserDevice *userDevice, NSError *error)
{
        if(error){
        //返回失败信息，根据error做不同的提示或者处理
        }else{
        //绑定成功后返回设备信息
        }  
}];
</code></pre>

<p>设备无法绑定时，请检查以下问题：</p>
<ul>
<li>1.设备已经被其他人绑定过了。</li>
<li>2.设备的domain和subdomain信息有误。</li>
<li>3.电源供电是否正常，建议更换电源。</li>
<li>4.确保设备的天线正常。</li>
<li>5.确保网络环境不是公共环境。</li>
</ul>
<p>绑定成功后，通过listdevice 接口可以列出已经绑定的设备列表。如果无法列出设备列表，请检查以下问题：</p>
<ul>
<li>1.设备电源供电不足造成断网。</li>
<li>2.WIFI信号不好造成断网。</li>
<li>3.路由器断网。</li>
</ul>
<h3 id="gprs">GPRS设备</h3>
<p><strong><font color="red">注</font>：GPRS设备无需激活流程，设备连接到GPRS后会自动连接云端完成激活。因此设备上电后就可以直接进入绑定流程。</strong>建议通过扫二维码的形式获取物理Id进行绑定。</p>
<pre><code class="objectivec">[ACBindManager bindDeviceWithSubDomain:subdomain physicalDeviceId:tmpdevice.deviceId
name:[deviceNames objectAtIndex:i] callback:^(ACUserDevice *userDevice, NSError *error)
{
        if(error){
        //返回失败信息，根据error做不同的提示或者处理
        }else{
        //绑定成功后返回设备信息
        }  
}];
</code></pre>

<blockquote>
<p><font color="red">建议流程</font>：若设备上有是否连接上AbleCloud云端的指示灯，则可以提示用户在指示灯亮起的时候绑定设备。若无指示灯，则可在用户点击开始绑定之后，建议通过CountDownTimer每隔2s钟绑定一次设备，在连续绑定几次之后再提示用户失败或成功。</p>
</blockquote>
<h3 id="_13">二．分享设备</h3>
<ul>
<li><strong>第一种分享方式是管理员输入用户的帐号（手机号）直接把设备分享给用户</strong></li>
<li><strong>第二种方式为管理员分享二维码后，用户再通过扫码的形式绑定设备获得设备的使用权。推荐使用第二种分享机制。</strong></li>
</ul>
<h4 id="1_3">1、管理员直接分享设备给普通用户</h4>
<pre><code class="objectivec">[ACBindManager bindDeviceWithUserSubdomain:subdomain deviceId:deviceId account:acount callback:^(NSError *error) {
          if(error){
          //返回失败信息，根据error做不同的提示或者处理
          }else{
          //成功分享设备给account用户
          }
}];
</code></pre>

<h4 id="2_3">2、管理员通过分享设备二维码的形式分享设备</h4>
<pre><code class="objectivec">[ACBindManager getShareCodeWithSubDomain:subDmoain deviceId:deviceId timeout:timeout callback:^(NSString *shareCode, NSError *error) {
          if(error){
          //返回失败信息，根据error做不同的提示或者处理
          }else{
          //成功获取分享吗
          }
}];

//普通用户通过分享码绑定设备
[ACBindManager bindDeviceWithShareCode:shareCode subDomain:subDomain deviceId:deviceId callback:^(ACUserDevice *userDevice, NSError *error) {
          if(error){
         //返回失败信息，根据error做不同的提示或者处理
         }else{
         //成功绑定管理员分享的设备
         }
}];
</code></pre>

<p><font color ="red"> 注：</font>管理员分享的二维码有有效期。默认为一个小时。调用getShareCodeWithSubDomain接口时开发者可以自定义有效时间。具体使用方法请参考<a href="../../reference/iOS/#_8">Reference-&gt;客户端-iOS-&gt;SDK接口列表-&gt;设备管理</a></p>
<h3 id="_14">三．设备解绑</h3>
<h4 id="1_4">1、管理员或普通用户解绑设备</h4>
<p><font color=red>注意：</font>如果是管理员解绑设备，那么其他绑定该设备的普通成员也会失去该设备的绑定权。</p>
<pre><code class="objectivec">[ACBindManager unbindDeviceWithSubDomain:subDomian deviceId:deviceId callback:^(NSError *error) {
         if(error){
         //返回失败信息，根据error做不同的提示或者处理
         }else{
         //解绑成功
        }
}];
</code></pre>

<h4 id="2_4">2、管理员取消其他普通成员对该设备的控制权</h4>
<pre><code class="objectivec">[ACBindManager unbindDeviceWithUserSubDomain:subDomain userId:userId deviceId:deviceId callback:^(NSError *error) {
         if(error){
         //返回失败信息，根据error做不同的提示或者处理
         }else{
         //解绑成功
         }
}];
</code></pre>

<h2 id="_15">网关型设备</h2>
<p>功能介绍参见 <a href="../../features/functions/#_6">功能说明-功能介绍-网关型设备管理</a></p>
<p>网关的绑定流程和WiFi设备是一样的。网关绑定以后绑定子设备的建议流程如下：</p>
<p><img alt="DM_gateway" src="../../pic/develop_guide/DM_gateway.png" /></p>
<p>该流程只是建议流程的一种。其中openGatewayMatch和closeGatewayMatch接口都是为了方便软件开启配对而开发的接口。如果使用硬件上的操作（如网关上有按钮等）完成网关和子设备的配对，则不需要用到这两个接口。</p>
<h3 id="_16">一．绑定网关</h3>
<h3 id="wifi_1">WiFi网关</h3>
<h4 id="1acwifilinkmanager_1">1.获取ACWifiLinkManager激活器</h4>
<p>AbleCloud提供了ACWifiLinkManager激活器供你使用。</p>
<pre><code class="objectivec">@interface ACWifiLinkManager : NSObject
ACWifiLinkManager * wifiManager = [[ACWifiLinkManager alloc] initWithLinkerName:@&quot;easylink&quot;];
</code></pre>

<p><font color="red">注</font>：linkerName表示开发板的型号，如果用的是其它的开发板，则需要修改。
目前支持的开发板有<code>smartlink</code>、<code>oneshot</code>、<code>easyconfig</code>、<code>easylink</code>、<code>smartconfig</code>。</p>
<h4 id="2wifi-ssid_1">2.得到WiFi SSID</h4>
<pre><code class="objectivec">NSString * ssid = [ACWifiLinkManager  getCurrentSSID ];
</code></pre>

<h4 id="3_3">3.激活网关</h4>
<p>APP通过startAbleLink广播自己的WiFi密码，设备成功连上云之后通过广播通知APP同时获取设备物理Id和subDomainId（用来区分设备类型）。当前只支持配置手机当前连接的WiFi。</p>
<pre><code class="objectivec">[wifiManager sendWifiInfo:ssid password:pwd timeout:timeout callback:^(NSArray *localDevices, NSError *error) {
          if(error){
          //返回失败信息，根据error做不同的提示或者处理，此处一般为1993配置超时错误
          }else{
          //成功后得到已激活设备的列表，从列表中得到物理id后进行绑定
         }  
}];
</code></pre>

<h4 id="4_2">4.绑定网关</h4>
<p>在成功激活设备后的回调方法中，通过物理Id绑定网关。</p>
<pre><code class="objectivec">[ACBindManager bindGatewayWithSubDomain:subDomain physicalDeviceId:physicalDeviceId name:name  callback:^(ACUserDevice *device, NSError *error) {
          if(error){
           //返回失败信息，根据error做不同的提示或者处理
          }else{
          //绑定成功后返回设备信息
         }  
}];
</code></pre>

<h3 id="_17">以太网网关</h3>
<p><font color="red">注</font>：以太网网关无需激活流程，在网关插上网线连上云端之后即可以直接进入绑定设备的流程。建议通过扫码的形式获取网关物理Id进行绑定。</p>
<pre><code class="objectivec">[ACBindManager bindGatewayWithSubDomain:subDomain physicalDeviceId:physicalDeviceId name:name  callback:^(ACUserDevice *device, NSError *error) {
        if(error){
        //返回失败信息，根据error做不同的提示或者处理
        }else{
        //绑定成功后返回设备信息
        }  
}];
</code></pre>

<h3 id="_18">二．绑定子设备</h3>
<h4 id="1_5">1．开启网关接入配对</h4>
<pre><code class="objectivec">//由于子设备接入网关是一个异步的过程，所以建议在这里new一个Timer去定时获取新加入的子设备列表，在activity退出时停止Timer
[ACBindManager openGatewayMatchWithSubDomain:subDomain gatewayDeviceId:gatewayDeviceId time:time callback:^(NSError *error) {
           if(error){
           //返回失败信息，根据error做不同的提示或者处理
           }else{
           //列举所有新加入的子设备列表 
           }   
}];
</code></pre>

<h4 id="2_5">2．列举所有新加入的子设备列表</h4>
<pre><code class="objectivec">[ACBindManager listSubDevicesWithSubDomain:subDomain gatewayDeviceId:deviceId callback:^(NSArray *devices, NSError *error) {
           if(error){
           //返回失败信息，根据error做不同的提示或者处理
           }else{
           //获取新加入的子设备列表成功
            } 
}];
</code></pre>

<p><font color-"red">注:</font>该接口可以在APP端列出所有当前被网关扫描出来的但之前尚未被添加到该网关的子设备。也就是，列表中的设备都可以直接调用addSubDevice接口添加到网关。</p>
<h4 id="3_4">3．绑定子设备</h4>
<p>通过上一步获取的子设备列表获取physicalDeviceId进行绑定。
如有用户确认过程的话，则在用户点击确认之后循环调用此接口绑定用户选择的子设备。</p>
<pre><code class="objectivec">[ACBindManager addSubDeviceWithSubDomain:subDomain gatewayDeviceId:deviceId physicalDeviceId:physicalDeviceId name:name  callback:^(ACUserDevice *device, NSError *error) {
           if(error){
           //返回失败信息，根据error做不同的提示或者处理
           }else{
           //添加子设备成功
          }  
}];
</code></pre>

<p><font color="red">注</font>：在绑定子设备addSubDevice的success回调里只是成功绑定该physicalDeviceId的单个设备，建议在成功绑定所有子设备之后再提示绑定成功。</p>
<p>若无法添加子设备时，请检查是否有以下问题：
1. 网关掉线
1. 子设备已经被其他人绑定
1. 子设备subdomain填写错误
2. 子设备和网关的连接断开了</p>
<h2 id="_19">设备扩展属性</h2>
<p>功能介绍参见 <a href="../../features/functions/#_11">功能说明-功能介绍-设备扩展属性</a></p>
<p><strong><font color="red">注意</font>：设备扩展属性需要先进入到控制台产品管理--&gt;产品列表--&gt;管理--&gt;产品属性--&gt;扩展属性--&gt;新建属性，建立完扩展属性列表后才能使用如下接口。</strong></p>
<h4 id="_20">一、设置或者更新设备扩展属性</h4>
<pre><code class="objectivec">[ACBindManager setDeviceProfileWithSubDomain:subDomain deviceId:deviceId profile:acobj  callback:^(NSError *error) {
            if(error){
            //返回失败信息，根据error做不同的提示或者处理
            }else{
            //修改设备扩展属性成功
            }  
}];
</code></pre>

<h4 id="_21">二、获取设备扩展属性</h4>
<pre><code class="objectivec">[ACBindManager getDeviceProfileWithSubDomain:subDomain deviceId:deviceId callback:^(ACObject *profile, NSError *error) {
            if(error){
            //返回失败信息，根据error做不同的提示或者处理
            }else{
            //获得设备扩展属性成功
            }  
}];
</code></pre>

<h1 id="_22">和云端通信</h1>
<p>功能介绍参见 <a href="../../features/functions/#_12">功能说明-功能介绍-和云端通信</a></p>
<p><font color="red">说明</font>在设备尚未开发完成时，在管理后台可以启动虚拟设备用于APP的调试。虚拟设备和真实设备使用方法相同，需要先绑定再使用。虚拟设备能够显示APP发到设备的指令，上报数据到云端、填入数据供APP查询。</p>
<h2 id="_23">一、发送消息到设备</h2>
<h3 id="klv">KLV格式</h3>
<p>KLV协议介绍请参考：<a href="../../reference/device/#klv">reference-设备-KLV协议介绍</a>。</p>
<p><strong>在新建产品的时候选择klv通讯协议，并填写功能点里的数据点与数据包。</strong>
这里创建的数据点和数据包如下所示：</p>
<p>【数据点】
<img alt="klv_datapoint" src="../../pic/develop_guide/cloud_communication_klv.png" /></p>
<p>【数据包】
<img alt="klv_datapackage" src="../../pic/develop_guide/cloud_communication_klv_pkg.png" /></p>
<p><strong>例如</strong>：以开关设备为例,协议如下:</p>
<pre><code class="objectivec">//请求数据包
{ 68 ：[
//数据点[key：value(int8)]
//关灯
{ 1 : 0 },
//开灯      
{ 1 : 1 }
]}
//响应数据包  
{ 60 ：[
//数据点[key：value(int8)]
//失败
{ 1 : 0 },
//成功      
{ 1 : 1 }
]}
</code></pre>

<p>定义如下:</p>
<pre><code class="objectivec">@interface ACKLVObject : NSObject

/**
* 获取一个参数值
* @param name   参数名
* @return       参数值
*/
- (ACKLVValue *)getValueForKey:(u_int16_t)key;
- (NSNull *)get:(u_int16_t)key;
- (BOOL)getBool:(u_int16_t)key;
- (Byte)getByte:(u_int16_t)key;
- (short)getShort:(u_int16_t)key;
- (int)getInt:(u_int16_t)key;
- (long)getLong:(u_int16_t)key;
- (float)getFloat:(u_int16_t)key;
- (double)getDouble:(u_int16_t)key;
- (NSString *)getString:(u_int16_t)key;
- (NSData *)getData:(u_int16_t)key;

/**
* 设置一个参数
* @param name   参数名
* @param value  参数值
* @return
*/
- (void)put:(u_int16_t)key;
- (void)putBool:(u_int16_t)key value:(BOOL)value;
- (void)putByte:(u_int16_t)key value:(Byte)value;
- (void)putShort:(u_int16_t)key value:(short)value;
- (void)putInt:(u_int16_t)key value:(int)value;
- (void)putLong:(u_int16_t)key value:(long)value;
- (void)putFloat:(u_int16_t)key value:(float)value;
- (void)putDouble:(u_int16_t)key value:(double)value;
- (void)putString:(u_int16_t)key value:(NSString *)value;
- (void)putData:(u_int16_t)key value:(NSData *)value;

- (BOOL)contains:(u_int16_t)key;
- (NSIndexSet *)getKeys;

- (BOOL)hasObjectData;
- (NSDictionary *)getObjectData;
- (void)setObjectData:(NSDictionary *)data;
</code></pre>

<h3 id="_24">二进制格式</h3>
<p><strong>在新建产品的时候选择数据格式为二进制，然后在功能点里面创建了数据包</strong></p>
<p>这里创建的数据点和数据包如下所示：</p>
<p>【数据点】
<img alt="binary_datapoint" src="../../pic/develop_guide/cloud_communication_binary.png" /></p>
<p>【数据包】
<img alt="binary_datapackage" src="../../pic/develop_guide/cloud_communication_binary_pkg.png" /></p>
<p><strong>例如</strong>：以开关设备为例,协议如下:</p>
<pre><code class="objectivec">//请求数据包
{ 68 ：[
//关灯(二进制流，由厂商自己解析)
{ 0 , 0 , 0 , 0 },
//开灯(二进制流，由厂商自己解析)   
{ 1 , 0 , 0 , 0 }
]}
//响应数据包  
{ 102 ：[
//失败(二进制流，由厂商自己解析)
{ 0 , 0 , 0 , 0 },
//成功(二进制流，由厂商自己解析)        
{ 1 , 0 , 0 , 0 }
]}
</code></pre>

<p>截取开灯代码，如下:</p>
<h4 id="1_6">1、设置序列化器</h4>
<pre><code class="objectivec">//反序列化
+ (instancetype)unmarshalWithData:(NSData *)data;

//序列化
- (NSData *)marshal;
</code></pre>

<h4 id="2_6">2、发送到设备</h4>
<pre><code class="objectivec">/**
*  网络连接操作灯
*/
- (void)operationLight:(LightOperationType)type
{
     DeviceMsg  *deMsg = self.device[0];
     NSString *subDomain = [[NSUserDefaults standardUserDefaults] stringForKey:@&quot;subDomain&quot;];;
     NSInteger deviceId = deMsg.deviceId;
     ACDeviceMsg *msg = [[ACDeviceMsg alloc]init];
     msg.msgId = 0;
     msg.msgCode =68;
     Byte content[] ={type,0,0,0};
     msg.payload = [NSData dataWithBytes:content length:sizeof(content)];
     [ACBindManager sendToDevice:subDomain deviceId:deviceId msg:msg callback:^(ACDeviceMsg *responseMsg, NSError *error) {
                 if (error) {
                  NSLog(@&quot;sendToDevice-error:%@&quot;,error);
                 }else
                   {
                   NSLog(@&quot;sendToDevice - 成功&quot;);
                   }
                   }];
}

</code></pre>

<h2 id="_25">二、发送消息到服务</h2>
<p><font color="red">注意</font>：serviceName对应服务管理里UDS服务里的<strong>服务名称</strong>，务必保持一致。进入版本管理之后，查看已上线版本。serviceVersion为<strong>主版本号</strong>，比如1-0-0，则version为1。</p>
<pre><code class="objectivec">ACMsg * msg = [[ACMsg alloc] init];
msg.context = [ACContext generateContextWithSubDomain:[CommonInfo getSubDomain]];
[msg setName:@&quot;createDeviceInitState&quot;];
[msg putLong:@&quot;deviceId&quot; value:userDevice.deviceId];
[msg putLong:@&quot;subDomainId&quot; value:userDevice.subDomainId];
ACServiceClient *serviceClient = [[ACServiceClient alloc]initWithHost:[CommonInfo getHost] service:[CommonInfo getServiceName] version:1];
[serviceClient sendToService:msg callback:^(ACMsg *responseObject, NSError *error)
{
         callback(responseObject,error);
}];
</code></pre>

<h2 id="_26">三、实时消息</h2>
<p>实时消息第一版的设计与store数据集直接相关，当数据表格的存储有发生变化时，如创建、更新、添加、删除操作时才会下发数据到APP。也就是说，如果要APP上实时显示数据变化，需要在管理后台创建数据集，并指定是否监控该数据集。然后写云端自定义服务，将需要实时显示的数据存储到该数据集中。这样当该数据集有变化时，APP端才能够实时显示对应的数据变化。</p>
<p><img alt="cloud_syn" src="../../pic/develop_guide/cloud_syn.png" /></p>
<h4 id="1_7">1、获取实时消息管理器</h4>
<pre><code class="c">#import &quot;ACPushManager.h&quot;
ACPushManager * pushManager = [[ACPushManager alloc] init];
</code></pre>

<h4 id="2_7">2、创建与服务器的连接</h4>
<pre><code class="c">[pushManager connectWithCallback:^(NSError *error) {
            if (!error) {
            //连接成功，可以订阅数据 
            }else{、
            //连接失败，网络错误 
            }
}];```

####3、订阅实时数据
以如下数据集为例：

![cloud_syn_1](../pic/develop_guide/cloud_syn_1.png)

```c
//实例化ACPushTable对象
ACPushTable *table  = [[ACPushTable alloc] init];
//设置订阅的表名
table.className = @&quot;BramcDeviceManager&quot;;
//设置订阅的columns行
table.cloumns = [NSMutableArray arrayWithObjects:@&quot;speed&quot;, nil];
//设置监听类型，如以下为只要发生创建、删除、替换、更新数据集的时候即会推送数据
table.opType =  OPTYPE_CREATE |OPTYPE_DELETE | OPTYPE_REPLACE | OPTYPE_UPDATE;
//设置监听主键，此处对应添加数据集时的监控主键(监控主键必须是数据集主键的子集)
ACObject * primaryKey = [[ACObject alloc] init];
[primaryKey putInteger:@&quot;deviceId&quot; value:100001];
table.primaryKey =primaryKey;
//可以多次调用以下此方法watch多个table
[pushManager watchWithTable:table Callback:^(NSError *error) {
             if (!error) {
             //订阅成功
             }else{
             //订阅失败，请自行检查参数类型，表名，columns以及监听主键是否与AbleCloud平台新建的数据集监听主键一致等是否有误。
             }
}];
</code></pre>

<h4 id="4_3">4、接收已订阅的实时数据</h4>
<pre><code class="c">[pushManager onReceiveWithCallback:^(ACPushReceive *pushReceive, NSError *error) {
             if (!error) {
             //pushReceive.className 表名
             //pushReceive.opType 接收类型，如ACPushTableOpType.CREATE
             //pushReceive.Payload 接收数据ACObject格式
             ACObject * obj = pushReceive.payload;
             long speed = [obj getLong:@&quot;windSpeed&quot;];
             }
}];
</code></pre>

<h4 id="5">5、取消订阅</h4>
<p>建议在退出订阅的activity之后调用，避免造成流量浪费。</p>
<pre><code class="c">//实例化ACPushTable对象
ACPushTable *table  = [[ACPushTable alloc] init];
//设置订阅的表名
table.className = @&quot;BramcDeviceManager&quot;;
//设置监听主键
ACObject * primaryKey = [[ACObject alloc] init];
[primaryKey putInteger:@&quot;deviceId&quot; value:100001];
table.primaryKey =primaryKey;

[pushManager unWatchWithPushTable:table Callback:^(NSError *error) {
             if (!error) {
             //取消订阅成功
            }else{
            //取消订阅失败，请自行检查参数类型，表名以及监听主键是否与AbleCloud平台新建的数据集监听主键一致等是否有误。
            }
}];
</code></pre>

<h1 id="_27">局域网通信</h1>
<p>功能说明参见<a href="../../features/functions/#_28">功能说明-局域网通信</a>。</p>
<p>获取设备列表（在网络环境差的情况下如果获取不到设备列表会从本地缓存里取设备列表）。</p>
<pre><code class="objectivec">[ACBindManager listDevicesWithStatusCallback:^(NSArray *devices, NSError *error) {
         if (!error) {
             for (ACUserDevice * device  in devices) 
             {
                    /**
                     * 设备在线状态(listDeviceWithStatus时返回，listDevice不返回该值)
                     * 0不在线 1云端在线 2局域网在线 3云端和局域网同时在线
                     * 若只选择直连的通讯方式，则只有在2和3的状态下才能往设备发送成功
                     */
                //设备在线状态
                NSInteger status = device.status;
             }
        }else{
        //网络错误且之前从来没有获取过设备列表时返回
        }

}];
</code></pre>

<p>因为局域网通讯要求设备与APP处于同一个WiFi下，若网络环境变化，如切换WiFi时，直连的状态会发生改变，所以需要监听网络环境变化。</p>
<pre><code class="objectivec">[ACBindManager networkChangeHanderCallback:^(NSError *error) {
         if (!error) {
         //当手机网络环境变化时，根据具体需求更新界面上的局域网状态或者不做处理或者重新获取设备列表

         }
}];
</code></pre>

<p>此外，由于网络环境较差或其他原因，使得在获取直连设备时有可能会超时丢包导致更新失败，所以若需要准确实时的获取局域网状态，则需要增加手动刷新局域网状态的功能。</p>
<pre><code class="objectivec">ACloud * cloud = [[ACloud alloc]init];
[cloud findLocalDeviceTimeout:1000 SudDomainId:subDomainId callback:^(NSArray *deviceList, NSError *error) {
         if (!error) {
         //发现局域网设备,根据更新局域网在线状态或者重新获取设备列表
          }else{
          //没有局域网设备，更新局域网在线状态或者重新获取设备列表
          }
}];
</code></pre>

<h1 id="_28">定时任务</h1>
<p>功能介绍参见 <a href="../../features/functions/#_19">功能说明-功能介绍-定时任务</a></p>
<h2 id="skip"><span class="skip">||SKIP||</span></h2>
<h4 id="-actimermanager">获取定时管理器－－ACTimerManager类</h4>
<p><strong>使用默认时区</strong></p>
<pre><code class="objectivec">
ACTimerManager ＊ timerMgr=［［ACTimerManager alloc］ init］;
</code></pre>

<p><strong>使用自定义时区</strong></p>
<pre><code class="objectivec">- (id)initWithTimeZone:(NSTimeZone *)timeZone {
       self = [super init];
       if (self) {
       self.timeZone = timeZone;
        }
        return self;
}
</code></pre>

<h4 id="_29">添加定时任务</h4>
<blockquote>
<p><strong><font color="red">注意</font>：</strong></p>
<p><strong>1、若与设备之间的通讯为二进制或json格式，则需要先设置序列化器（与发送到设备相同），若为klv格式则不需要设置，具体参考与云端通讯中的发送到设备。</strong></p>
<p><strong>2、timePoint的格式为<code>"yyyy-MM-dd HH:mm:ss"</code>，否则会失败。</strong></p>
<p><strong>3、timeCycle需要在timePoint时间点的基础上,选择循环方式。</strong></p>
<ul>
<li>
<p><strong>"once":</strong>单次循环</p>
</li>
<li>
<p><strong>"min":</strong>在每分钟的<strong><code>ss</code></strong>时间点循环执行</p>
</li>
<li>
<p><strong>"hour":</strong>在每小时的<strong><code>mm:ss</code></strong>时间点循环执行</p>
</li>
<li>
<p><strong>"day":</strong>在每天的<strong><code>HH:mm:ss</code></strong>时间点循环执行</p>
</li>
<li>
<p><strong>"month":</strong>在每月的<strong><code>dd HH:mm:ss</code></strong>时间点循环执行</p>
</li>
<li>
<p><strong>"year":</strong>在每年的<strong><code>MM-dd HH:mm:ss</code></strong>时间点循环执行</p>
</li>
<li>
<p><strong>"week[0,1,2,3,4,5,6]":</strong>在每星期的<strong><code>HH:mm:ss</code></strong>时间点循环执行(如周一，周五重复，则表示为"week[1,5]")</p>
</li>
</ul>
</blockquote>
<h4 id="_30">添加定时任务</h4>
<pre><code class="objectivec">ACDeviceMsg * dmsg = [[ACDeviceMsg alloc] init];
dmsg.msgCode = 68;
//payload根据厂商而定，此处只是示例
dmsg.payload = [OrderInfoTwo getOrderInfo:@&quot;SWITCH_ON&quot;];
[timerMgr addTaskWithdeviceId:self.upDeviceId name:nameStr timePoint:resultString timeCycle:weekStr description:switchStr deviceMsg:dmsg callback:^( NSError *error) {
        if (error)
        {
        NSLog(@&quot;添加定时失败&quot;);
        }
        else
        {
        NSLog(@&quot;添加定时成功&quot;);
        }
}];
</code></pre>

<h4 id="_31">修改定时任务</h4>
<p>接口为modifyTask，其他参数与定义与创建定时任务相同。</p>
<h4 id="_32">开启定时任务</h4>
<p>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</p>
<pre><code class="c">[timerMgr openTaskWithDeviceId:self.upDeivceId taskId:acTask.taskId callback:^(NSError *error) {
=======
```objectivec
[DeviceMsg openTaskWithDeviceId:self.upDeivceId taskId:acTask.taskId callback:^(NSError *error) {
&gt;&gt;&gt;&gt;&gt;&gt;&gt; d84050087dcaf994eb56b5c637ee8e4eaf37daef
        if (error) { 
        NSLog(@&quot;预约开失败－－%@&quot;,error);
        }else{
        NSLog(@&quot;预约开成功&quot;);
        }
}];
</code></pre>

<h4 id="_33">关闭定时任务</h4>
<pre><code class="objectivec">[DeviceMsg closeTaskWithDeviceId:self.upDeivceId taskId:acTask.taskId callback:^(NSError *error) {
         if (error){
         NSLog(@&quot;预约关失败－－%@&quot;,error);
         }else{
         NSLog(@&quot;预约关成功&quot;);
         }
}];

</code></pre>

<h4 id="_34">删除定时任务</h4>
<p>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</p>
<pre><code class="c">[timerMgr deleteTaskWithDeviceId:self.upDeivceId taskId:ac.taskId callback:^(NSError *error){
=======
```objectivec
[DeviceMsg deleteTaskWithDeviceId:self.upDeivceId taskId:ac.taskId callback:^(NSError *error){
&gt;&gt;&gt;&gt;&gt;&gt;&gt; d84050087dcaf994eb56b5c637ee8e4eaf37daef
          if (error){
          //删除定时失败，处理error
          }else{
          //删除定时成功
          }
}];
</code></pre>

<h4 id="_35">获取定时任务列表</h4>
<p>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</p>
<pre><code class="c">[timerMgr listTasksWithDeviceId:deviceId callback:^(NSArray *timerTaskArray, NSError *error) {
=======
```objectivec
[DeviceMsg firstLoadTimerWithdeviceId:self.upDeivceId callback:^(NSArray *timerTaskArray, NSError *error) {
&gt;&gt;&gt;&gt;&gt;&gt;&gt; d84050087dcaf994eb56b5c637ee8e4eaf37daef
         if (error)
          {
          NSLog(@&quot;获取定时信息失败%@&quot;,error);
           }
          else
          {
          //获取定时任务成功
           }
}];
</code></pre>

<h1 id="ota">OTA</h1>
<p>功能介绍参见 <a href="../../features/functions/#ota">功能说明-功能介绍-OTA</a></p>
<h2 id="skip_1"><span class="skip">||SKIP||</span></h2>
<p><img alt="OTA" src="../../pic/develop_guide/OTA.png" /></p>
<p>说明参见<a href="../../introduction/#ota">功能说明-OTA</a>。</p>
<p>若使用场景为开启APP之后自动检测升级，建议把检测升级过程放在application里，并维护一个deviceId和ACOTAUpgradeInfo的映射关系，通过static修饰放到内存里，在进入OTA升级页面后可以直接取出来显示。如想实现用户取消升级之后不再提示功能，则可以自己维护一个变量记录。</p>
<h4 id="ota-acotamanager">一.获取OTA管理器对象--ACOTAManager类</h4>
<pre><code class="objectivec">@interface ACOTAManager : NSObject
</code></pre>

<h4 id="_36">二. 检查升级</h4>
<p>检查设备是否有新的OTA版本，同时获取升级日志。</p>
<pre><code class="objectivec">[ACOTAManager checkUpdateWithSubDomain:subDomain deviceId:deviceId callback:^(ACOTAUpgradeInfo *upgradeInfo, NSError *error) {
         if(error){
          //返回失败信息，根据error做不同的提示或者处理
          }else{
           /*
            *ACOTAUpgradeInfo *upgradeInfo = [[ACOTAUpgradeInfo alloc] init];
            * 通过判断upgradeInfo.oldVersion和upgradeInfo.upgradeVersion是否相等判断是否有新版本更新
            * upgradeInfo.oldVersion为老版本，upgradeInfo.upgradeVersion upgradeInfo.upgradeLog为升级日志
            */
           }
}];
</code></pre>

<h4 id="_37">三．确认升级</h4>
<pre><code class="objectivec">[ACOTAManager confirmUpdateWithSubDomain:subDomain deviceId:deviceId newVersion:newVersion callback:^(NSError *error) {
          if(error){
          //返回失败信息，根据error做不同的提示或者处理
          }else{
          //确认升级
         }
}];
</code></pre>

<h1 id="_38">推送</h1>
<p>功能介绍参见 <a href="../../features/functions/#20">功能说明-功能介绍-和云端通信</a></p>
<p>AbleCloud的推送使用<a href="http://www.umeng.com/">友盟</a>的服务，在开发功能之前，现需要进行一些配置。</p>
<h2 id="_39">推送开发准备</h2>
<p>下面以友盟推送为例，介绍开发推送功能前需要做的准备工作。</p>
<p>首先，需要创建友盟推送账号，并创建应用（安卓和iOS版本需要单独创建），如下图所示。</p>
<p><img alt="push1" src="../../pic/develop_guide/push1.png" /> </p>
<p>记录“应用信息”中的AppKey和App Master Secret，将其填写到test.ablecloud.cn中。AbleCloud和友盟已经达成合作协议，服务器IP地址一项不需要填写。</p>
<p><img alt="push2" src="../../pic/develop_guide/push2.png" /> </p>
<p>友盟平台配置完成后，到AbleCloud的管理后台的推送管理页面填写对应信息即可使用AbleCloud提供的推送服务。</p>
<blockquote>
<p><font color="red">注意</font></p>
<p>1、调试的时候若开发环境配置有变化的话尽量手动卸载APP之后再重新安装。</p>
<p>2、推荐先登录友盟推送的后台进行推送测试，若能收到推送通知即代表流程通过，最后再与UDS服务进行下一步测试。</p>
<p>3、推荐先使用友盟推送后台的设备状态查询（通过接口获取）或者设备别名查询（即登录成功之后的userId）等工具确认是否成功注册推送服务。若注册成功之后仍没有收到通知消息，再检查一下开发环境配置。</p>
</blockquote>
<h2 id="_40">一、推送准备</h2>
<h4 id="appkey-umeng-message-secret">添加 AppKey 和 Umeng Message Secret</h4>
<h2 id="_41">二、开启推送服务</h2>
<p>AbleCloud在SDK中提供了与推送服务相关的接口（封装了友盟的部分接口），定义如下：</p>
<h4 id="1-acnotificationmanager">1、获取推送管理器－－ACNotificationManager类</h4>
<pre><code class="objectivec">@interface ACNotificationManager : NSObject
</code></pre>

<h4 id="2_8">2、在应用的启动函数中开启推送服务</h4>
<pre><code class="objectivec">- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions 
{
        [ACNotificationManager       startWithAppkey:@&quot;您的appKey&quot; launchOptions:launchOptions];
}
</code></pre>

<h4 id="3_5">3、在登录成功之后添加推送别名</h4>
<pre><code class="objectivec">[ACNotificationManager addAliasWithUserId:user.userId callback:^(NSError *error) {
         if(error){
         NSLog(@&quot;推送添加别名失败&quot;);
         }else{
         //成功
         }
}];
</code></pre>

<h4 id="4_4">4、在退出登录之后移除掉旧的别名</h4>
<pre><code class="objectivec">[ACNotificationManager removeAliasWithUserId:uid callback:^(NSError *error){
           if(error){
             //移除失败，处理错误信息
            }else{
            //移除成功
            }
}
</code></pre>

<h1 id="_42">文件存储</h1>
<p>功能介绍参见 <a href="../../features/functions/#_21">功能说明-功能介绍-文件存储</a></p>
<blockquote>
<p><font color="red">注意</font>：</p>
<p>1、iOS权限原因，下载文件上传文件到云端只能在本应用的沙盒中操作</p>
<p>2、文件下载功能是基于系统自带的NSURLSession框架实现,文件上传功能是借助第三方七牛云存储实现</p>
<p>3、上传下载支持断点续传功能</p>
</blockquote>
<h2 id="_43">一、获取文件管理器</h2>
<pre><code class="objectivec">ACFileManager * fileManager =[[ACFileManager alloc] init];
</code></pre>

<h2 id="_44">二、下载文件</h2>
<h3 id="1url">1、获取下载url</h3>
<pre><code class="objectivec">[ACFileManager getDownloadUrlWithfile:fileInfo ExpireTime:0 payloadCallback:^(NSString *urlString, NSError *error)
{
          if(error ){
           //获取URL失败，根据error作出不同的处理
           }else{
           //下载文件
            }
}
</code></pre>

<h3 id="2url">2、根据url下载文件</h3>
<pre><code class="objectivec">[downManager downFileWithsession:urlString callBack:^(float progress, NSError *error)
{
          if(error ){
           //下载失败，处理error
           }else{
           //下载成功，处理下载的文件
           }
}
</code></pre>

<h2 id="_45">三、上传文件</h2>
<h3 id="1-acacl">1、设置上传文件的权限管理类－－ACACL</h3>
<pre><code class="objectivec">@interface ACACL : NSObject
</code></pre>

<p><font color="red"><strong>规则</strong>：</font>优先判断黑名单，黑名单命中后其他设置无效，其次判断白名单，最后判断全局设置属性。</p>
<h3 id="2_9">2、上传文件</h3>
<h4 id="1-acfileinfo">1)、设置上传文件信息－－ACFileInfo类</h4>
<pre><code class="objectivec">@interface ACFileInfo : NSObject
//上传文件名字
@property (copy,nonatomic) NSString * name;

//上传文件路径，支持断点续传
@property (copy,nonatomic) NSString * filePath;

//文件访问权限 如果不设置 则默认
@property (retain,nonatomic) ACACL  * acl;

//文件存储的空间   用户自定义   如名字为Image或者text的文件夹下
@property (copy,nonatomic) NSString * bucket;

-(id)initWithName:(NSString *)name bucket:(NSString *)bucket  ;
+ (instancetype)fileInfoWithName:(NSString *)name bucket:(NSString *)bucket ;
</code></pre>

<h4 id="2_10">2)、设置文件权限</h4>
<pre><code class="objectivec">/**
* 设置全局可读访问权限，不设置则默认为所有人可读
* @param allow 是否全局可读
*/
-(void)setPublicReadAccess:(BOOL)allow;

/**
* 设置全局可写访问权限，不设置则默认为除自己外的所有人不可写
* @param allow 是否全局可写
*/
-(void)setPublicWriteAccess:(BOOL)allow;

/**
* 设置用户可访问权限（白名单）
* @param opType 权限类型，OpType.READ为可读权限，OpType.WRITE为可写权限
* @param userId 被设置用户Id
*/
-(void)setUserAccess:(OpType)optype userId:(long)userId;

/**
* 设置用户访问权限（黑名单）
* @param opType 权限类型，OpType.READ为可读权限，OpType.WRITE为可写权限
* @param userId 被设置用户Id
*/
-(void)setUserDeny:(OpType)optype userId:(long)userId;
</code></pre>

<h4 id="3_6">3)、上传文件</h4>
<pre><code class="objectivec">ACFileInfo * fileInfo = [[ACFileInfo alloc] initWithName:@&quot;3.jpg&quot; bucket:@&quot;jpg&quot;];
fileInfo.filePath = [self getPath];
fileInfo.acl = [[ACACL alloc] init];
upManager = [[ACFileManager alloc] init];
[upManager uploadFileWithfileInfo:fileInfo progressCallback:^(NSString *key, float progress)
{ 
     if(error){
      //上传失败，处理error
     }else{
     //上传成功
     }
}


/**
* //取消上传
* @param subDomain     用户subDmomain
* @param fileInfo      文件信息
*/
-(void)cancleUploadWithfileInfo:(ACFileInfo *)fileInfo;
</code></pre>

<h1 id="error-code">Error Code</h1>
<p>参考<a href="../../reference/error_code/">reference-Error Code</a></p>
<blockquote>
<ul>
<li><strong>建议在调用AbleCloud云服务接口之前先判断网络处于可访问状态之后再调用相关接口，可以省去对error回调里网络错误的处理。</strong></li>
<li><strong>调试阶段，可通过返回的ACMsg 调用- (NSInteger)getErrCode;
和- (NSString *)getErrMsg;获取错误信息。</strong></li>
</ul>
</blockquote></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <div class="clear footer">
                &copy;2015&nbsp;&nbsp;北京智云奇点科技有限公司&nbsp;&nbsp;<a href="http://www.miit.gov.cn/" target="_blank">京ICP备14010946号-1</a>
            </div>
        </footer>

        <script type="text/javascript" src="../../js/jquery-1.10.2.min.js"></script>
        <script type="text/javascript" src="../../js/bootstrap.min.js"></script>
        <script type="text/javascript" src="../../js/highlight.pack.js"></script>
        <script type="text/javascript" src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
