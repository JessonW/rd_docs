<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>功能介绍 - AbleCloud 开发文档</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation" style="background:#00b5f1;border:0px solid transparent;height:50px;">
    <div class="container container-ac">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../../introduction/"><img src="../../img/logo.png" /><span style="margin-left:20px; margin-right:20px;">|</span>开发文档</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse" style="margin-left:293px;">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav nav-ac">
                
                
                    <li >
                        <a href="../../introduction/" >基本介绍</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">功能说明 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../concepts/">基本概念</a>
</li>

                        
                            
<li class="active">
    <a href="./">功能介绍</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">开发指导 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../develop_guide/android/">客户端-安卓</a>
</li>

                        
                            
<li >
    <a href="../../develop_guide/iOS/">客户端-iOS</a>
</li>

                        
                            
<li >
    <a href="../../develop_guide/wechat/">客户端-微信</a>
</li>

                        
                            
<li >
    <a href="../../develop_guide/device/">设备-嵌入式系统</a>
</li>

                        
                            
<li >
    <a href="../../develop_guide/device_android/">设备-安卓系统</a>
</li>

                        
                            
<li >
    <a href="../../develop_guide/cloud/">云端服务</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../reference/android/">客户端-安卓</a>
</li>

                        
                            
<li >
    <a href="../../reference/iOS/">客户端-iOS</a>
</li>

                        
                            
<li >
    <a href="../../reference/wechat/">客户端-微信</a>
</li>

                        
                            
<li >
    <a href="../../reference/device/">设备-嵌入式系统</a>
</li>

                        
                            
<li >
    <a href="../../reference/device_android/">设备-安卓系统</a>
</li>

                        
                            
<li >
    <a href="../../reference/cloud/">云端服务</a>
</li>

                        
                            
<li >
    <a href="../../reference/php/">PHP SDK</a>
</li>

                        
                            
<li >
    <a href="../../reference/java/">Java SDK</a>
</li>

                        
                            
<li >
    <a href="../../reference/error_code/">Error Code</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../../QandA/" >Q&A</a>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://docs.ablecloud.cn/1.0/introduction/" style="font-size:0.9em;">旧版文档</a></li>
            </ul>
        </div>

    </div>

</div>

        <div class="container container-ac">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        
        
            
                
            
        
            
                
            
        
            
                
            
        
        
        <li class="main active">
            <a href="#_1">帐号管理<span class="main-set parent__1">+</span></a>
        </li>
        
            
            <li class="sub parent__1" style="display: none;"><a href="#1ablecloud">1、AbleCloud普通帐号注册</a></li>
            
        
            
            <li class="sub parent__1" style="display: none;"><a href="#2">2、普通帐号和第三方帐号绑定</a></li>
            
        
            
            <li class="sub parent__1" style="display: none;"><a href="#3">3、帐号扩展属性</a></li>
            
        
    
        
        
            
                
            
        
            
                
            
        
            
                
            
        
            
                
            
        
        
        <li class="main">
            <a href="#_2">设备管理<span class="main-set parent__2">+</span></a>
        </li>
        
            
            <li class="sub parent__2" style="display: none;"><a href="#_3">独立设备管理</a></li>
            
        
            
            <li class="sub parent__2" style="display: none;"><a href="#_6">网关型设备管理</a></li>
            
        
            
            <li class="sub parent__2" style="display: none;"><a href="#home">home模型</a></li>
            
        
            
            <li class="sub parent__2" style="display: none;"><a href="#_11">设备扩展属性</a></li>
            
        
    
        
        
            
                
            
        
            
                
            
        
            
                
            
        
            
                
            
        
            
                
            
        
        
        <li class="main">
            <a href="#_12">云端通信<span class="main-set parent__12">+</span></a>
        </li>
        
            
            <li class="sub parent__12" style="display: none;"><a href="#_13">发送消息到设备</a></li>
            
        
            
            <li class="sub parent__12" style="display: none;"><a href="#_14">发送消息到服务</a></li>
            
        
            
            <li class="sub parent__12" style="display: none;"><a href="#_15">实时消息同步</a></li>
            
        
            
            <li class="sub parent__12" style="display: none;"><a href="#_16">设备上报消息</a></li>
            
        
            
            <li class="sub parent__12" style="display: none;"><a href="#_17">设备接收云端指令</a></li>
            
        
    
        
        
        
        <li class="main">
            <a href="#_18">局域网通信</a>
        </li>
        
    
        
        
        
        <li class="main">
            <a href="#_19">定时任务</a>
        </li>
        
    
        
        
        
        <li class="main">
            <a href="#ota">OTA</a>
        </li>
        
    
        
        
        
        <li class="main">
            <a href="#_20">推送</a>
        </li>
        
    
        
        
        
        <li class="main">
            <a href="#_21">短信通知</a>
        </li>
        
    
        
        
        
        <li class="main">
            <a href="#_22">文件存储</a>
        </li>
        
    
        
        
            
                
            
        
        
        <li class="main">
            <a href="#_23">第三方云对接<span class="main-set parent__23">+</span></a>
        </li>
        
            
            <li class="sub parent__23" style="display: none;"><a href="#_24">微信</a></li>
            
        
    
        
        
            
                
            
        
            
                
            
        
            
                
            
        
            
                
            
        
            
                
            
        
            
                
            
        
        
        <li class="main">
            <a href="#_25">名词解释<span class="main-set parent__25">+</span></a>
        </li>
        
            
            <li class="sub parent__25" style="display: none;"><a href="#_26">通用</a></li>
            
        
            
            <li class="sub parent__25" style="display: none;"><a href="#_27">产品定义相关</a></li>
            
        
            
            <li class="sub parent__25" style="display: none;"><a href="#_28">服务相关</a></li>
            
        
            
            <li class="sub parent__25" style="display: none;"><a href="#_29">帐号相关</a></li>
            
        
            
            <li class="sub parent__25" style="display: none;"><a href="#_30">设备相关</a></li>
            
        
            
            <li class="sub parent__25" style="display: none;"><a href="#_31">开发调试相关</a></li>
            
        
    
        
        
            
                
            
        
            
                
            
        
            
                
            
        
            
                
            
        
        
        <li class="main">
            <a href="#klv">KLV协议介绍<span class="main-set parent_klv">+</span></a>
        </li>
        
            
            <li class="sub parent_klv" style="display: none;"><a href="#_32">设备侧使用说明</a></li>
            
        
            
            <li class="sub parent_klv" style="display: none;"><a href="#udsapp">UDS/APP侧使用说明</a></li>
            
        
            
            <li class="sub parent_klv" style="display: none;"><a href="#_33">厂商管理后台的使用说明</a></li>
            
        
            
            <li class="sub parent_klv" style="display: none;"><a href="#_34">云端消息解析</a></li>
            
        
    
        
        
            
                
            
        
        
        <li class="main">
            <a href="#json">JSON<span class="main-set parent_json">+</span></a>
        </li>
        
            
            <li class="sub parent_json" style="display: none;"><a href="#_35">厂商管理后台使用说明</a></li>
            
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="_1">帐号管理</h1>
<p>考虑到所有的智能设备，最终都需要由用户来操作，因此，用户在对设备进行管理前，首先需要注册帐号或者使用第三方帐号登录。AbleCloud提供了安全的帐号体系，开发者可以直接用云端的帐号管理服务，实现自己的帐号系统，如用户注册、登录、修改密码、找回密码、发送手机验证码、第三方登录、上传用户头像、填写用户个人信息等相关的功能。</p>
<p>AbleCloud提供两种帐号系统：</p>
<ul>
<li>一、通过APP注册的用户为普通账号；</li>
<li>二、通过第三方帐号（比如微信，微博，QQ， 京东帐号）OAuth协议登录的帐号为第三方帐号。</li>
</ul>
<h2 id="1ablecloud">1、AbleCloud普通帐号注册</h2>
<ul>
<li>一般注册需要引导用户填写手机号码，然后发送短信验证码，为了防止频繁发送短信，一般设置倒计时1分钟（国内用户推荐使用手机注册）； </li>
<li>普通帐号也可以通过邮箱注册，部分地区的国外用户习惯用邮箱注册，也可以邮箱、手机号信息都写，对于仅通过邮箱注册的用户，会将验证码发送到注册邮箱；</li>
<li>用户填写收到的验证码，通过验证码来验证是否是真实的用户。验证码的有效期为10分钟，验证通过后会立即失效；</li>
<li>注册中用户可以设置昵称，昵称没有唯一性要求，不同的用户可以重名，但不能通过昵称进行登录。</li>
</ul>
<p>AbleCloud建议每个APP页面只实现一个功能，该功能用户操作成功以后再跳转到下个页面。APP开发者需要将整个流程中的意外情况做合理的处理，保证用户在使用过程中所有流程都是通顺的。</p>
<p>建议的流程如下图：</p>
<p><img alt="account1" src="../../pic/features/account1.png" /> </p>
<h2 id="2">2、普通帐号和第三方帐号绑定</h2>
<ul>
<li>普通帐号在登录后，可以绑定多个第三方帐号（微信、微博、QQ等）。绑定第三方帐号成功后，可以通过第三方帐号直接登录系统，并获取此普通帐号的相关数据，比如获取设备列表信息。普通帐号绑定第三方帐号时，不允许绑定一个已经注册或者已经被绑定的第三方帐号；</li>
<li>系统支持第三方帐号的直接注册登录，APP端在完成OAuth认证登录之后，可以直接进行设备管理。同时，登录后的第三方帐号可以绑定一个未被注册的普通帐号，绑定普通帐号成功后，可以通过普通帐号直接登录系统，并获取此第三方帐号的相关数据，比如获取设备列表。</li>
</ul>
<p>建议的交互流程如下图：</p>
<p><strong>第三方帐号登录</strong></p>
<p><img alt="account2" src="../../pic/features/account2.png" /> </p>
<p><strong>普通帐号注册后绑定第三方帐号</strong></p>
<p><img alt="account3" src="../../pic/features/account3.png" /> </p>
<p><strong>第三方帐号登录后绑定普通帐号</strong></p>
<p><img alt="account4" src="../../pic/features/account4.png" /> </p>
<h2 id="3">3、帐号扩展属性</h2>
<p>AbleCloud的基本帐号属性只包括账户名和密码以及用户昵称。如果厂商的APP中需要用户填写更多信息，如性别，年龄等，需要用到帐号扩展属性。若要使用帐号的扩展属性，首先需要在管理后台的帐号管理中进行定义。如下图所示：</p>
<p><img alt="account_appendix" src="../../pic/features/account_appendix.png" /> </p>
<p>其中：属性标识是该属性的唯一标识，在SDK的扩展属性接口中需要作为参数。</p>
<p>在当前主流的设计中，为了简化用户的注册流程，帐号的扩展属性一般都是在用户完成注册以后补充填写，在帐号的注册过程中不填写。</p>
<p>建议的交互流程如下：</p>
<p><img alt="account5" src="../../pic/features/account5.png" /> </p>
<p>开发指导请参考：</p>
<p><a href="../../develop_guide/android/#_5">开发指导-安卓-帐号管理</a></p>
<p><a href="../../develop_guide/iOS/#_6">开发指导-iOS-帐号管理</a></p>
<p><a href="../../develop_guide/wechat/#_3">开发指导-微信-帐号管理</a></p>
<p>如果需要存储用户的头像，请参考 <a href="../functions#_21">文件存储</a></p>
<h1 id="_2">设备管理</h1>
<h2 id="_3">独立设备管理</h2>
<h3 id="_4">功能介绍</h3>
<p>独立设备指的是能够直接访问互联网、和云端进行交互的设备。</p>
<p>典型的独立设备包括通过WiFi连接网络的设备、通过蜂窝网络（GPRS）连接网络的设备和通过以太网连接网络的设备。</p>
<p>独立设备的管理内容包括：设备绑定、设备解绑、设备删除、设备分享、邀请用户、更换管理员、更换设备等。</p>
<p>AbleCloud提供的客户端的SDK中包括设备管理需要的接口。</p>
<p>AbleCloud的设备管理采用基于管理员的方案。即每个设备都有一个管理员，对设备有终极管理权限，可以将设备分享给其他人或者收回其他人的使用权。其他人为普通用户，普通用户只有使用权。普通用户需要从管理员那里获得设备的使用权。</p>
<p><strong>独立设备安全管理策略</strong></p>
<ol>
<li>第一个绑定的人是设备的管理员，有管理员权限。</li>
<li>只有管理员能够分享设备，或者将某个用户添加成为具有权限的用户。同时管理员可以取消普通用户的绑定。</li>
<li>管理员删除设备，所有绑定关系解除，设备可视为新设备。设备上也有取消所有绑定关系的接口，厂商根据需求调用。</li>
<li>管理员删除设备后，所有用户对设备产生的历史数据都不可见。但该数据并未删除，只是与原设备的逻辑ID对应。厂商可以自己决定数据是记录在设备ID下还是用户ID下。对于医疗类和人相关的设备，建议记录在用户ID下。</li>
<li>管理员可以将身份转让给其他普通成员，原来的绑定关系不变。</li>
<li>设备发生故障，可以更换设备，所有绑定关系不变。</li>
</ol>
<h3 id="_5">建议的交互流程</h3>
<p>对于WiFi类设备，可以通过局域网广播自己的物理ID，APP接收广播完成绑定。</p>
<p><img alt="DM_WiFi1" src="../../pic/features/DM_WiFi1.png" /> </p>
<p>对于蜂窝网络设备，没有局域网，需要APP扫描设备的物理ID（一般是二维码）来完成设备的绑定。</p>
<p>客户端为微信时，绑定不要求设备在线（与APP相比，微信的特殊之处）,微信的绑定流程如下所示：</p>
<p><img alt="DM_WiFi2" src="../../pic/features/DM_WiFi2.png" /> </p>
<p>第一个绑定的用户绑定成功后成为该设备的管理员，可以通过生成设备分享二维码或者邀请其他用户的方式分享设备的使用权。</p>
<p><strong>1、管理员分享</strong></p>
<p><img alt="DM_WiFi3" src="../../pic/features/DM_WiFi3.png" /> </p>
<p><strong>2、管理员邀请</strong></p>
<p><img alt="DM_WiFi4" src="../../pic/features/DM_WiFi4.png" /> </p>
<p>对于使用二维码分享方式分享设备使用权的，开发者可以自己定义二维码有效期，过了有效期再扫描的时候也不能够获得设备使用权。</p>
<p>对于使用邀请方式分享的，要求被邀请人已经注册。</p>
<p>客户端为微信时，目前AbleCloud只能够支持管理员分享的方式分享设备。</p>
<p>开发指导参考：</p>
<p><a href="../../develop_guide/android/#_12">开发指导-安卓-独立设备管理</a></p>
<p><a href="../../develop_guide/iOS/#_14">开发指导-iOS-独立设备管理</a></p>
<p><a href="../../develop_guide/wechat/#_9">开发指导-微信-独立设备管理</a></p>
<p><a href="../../develop_guide/device/#_4">开发指导-设备-设备激活</a></p>
<h2 id="_6">网关型设备管理</h2>
<h3 id="_7">功能介绍</h3>
<p>网关型设备是指结构如下图所示包括网关和子设备类型的设备。</p>
<p><img alt="gateway" src="../../pic/features/gatewaydevice.png" /> </p>
<p>其中网关是只能够通过TCP/IP协议和云端通信并且能够将其他协议转换为TCP/IP协议的设备。网关与子设备通信可以是Zigbee、蓝牙、RF、Z-wave、易能森、PLC等任意协议。AbleCloud只能够直接管理到网关，并不能够和网关下面的子设备直接通信。</p>
<p>网关和子设备都需要在管理后台进行独立的产品定义，子设备有独立的产品名称和subdomain用以区分子设备类型。</p>
<p>为了对子设备进行管理，需要网关按照约定的格式上报子设备的subdomian信息和物理ID信息。</p>
<p>网关型设备的管理采用和WiFi类设备相同的管理员模式，因此只有网关的管理员才对网关有管理权限。同时网关和子设备有主从关系，即子设备属于网关。所以，网关的管理员就是子设备的管理员。</p>
<p>网关的管理员可以选择将网关分享给普通用户，这时候，普通用户对网关和网关下面的所有子设备有使用权。管理员也可以选择只将子设备分享给普通用户，这时候，被分享的用户只对该子设备有使用权，对其他子设备以及网关没有使用权。但是将子设备单独分享给普通用户时，在某些情况下会有权限混乱的风险，不建议使用。</p>
<p><strong>网关型设备安全管理策略</strong></p>
<ol>
<li>第一个绑定网关的人是网关的管理员，同时也是网关下面的子设备的管理员。</li>
<li>添加到网关的子设备必须没有被绑定过，否则无法添加。</li>
<li>只有管理员能够分享设备，或者将某个用户添加成为具有权限的用户。</li>
<li>管理员如果将网关分享了，那么被分享用户的权限包括网关和网关下的子设备。</li>
<li>管理员可以单独分享子设备，被分享用户的权限只包括子设备。</li>
<li>管理员删除网关，网关和下面的子设备一起删除，所有和网关以及子设备的绑定关系解除，网关和子设备可视为新设备。普通用户删除网关，只是取消对该网关以及网关的子设备的使用权，对其他所有用户无影响。</li>
<li>管理员删除设备（包括网关和子设备）后，所有用户对设备产生的历史数据都不可见。但该数据并未删除，只是与原设备的逻辑ID对应。厂商可以自己决定数据是记录在设备ID下还是用户ID下。对于医疗类和人相关的设备，建议记录在用户ID下。</li>
<li>管理员可以将身份转让给其他普通成员，原来的绑定关系不变。</li>
<li>设备发生故障，可以更换设备，所有所有绑定关系不变。</li>
</ol>
<h3 id="_8">建议的交互流程</h3>
<p><strong>1、绑定网关</strong>
对于一台（或一套）新设备，首先要绑定网关才能够使用，第一个绑定的人成为管理员。和WiFi设备的绑定一样，为了防止被恶意攻击，要求网关云端在线（微信不需要）。如果网关是通过WiFi连接无线路由器的，绑定网关的建议操作流程和<a href="./#_3">绑定WiFi设备</a>是一样的。对于网关是通过以太网连接路由器的场景，建议的用户交互流程如下：</p>
<p><img alt="DM_gateway1" src="../../pic/features/DM_gateway1.png" /> </p>
<p>客户端为微信,网关为WiFi设备时，同绑定WiFi设备的流程一样。客户端为微信，网关通过以太网连接路由器时，直接扫描网关上的二维码就完成了设备的绑定（不要求网关在线），流程如下：</p>
<p><img alt="DM_gateway2" src="../../pic/features/DM_gateway2.png" />  </p>
<p><strong>2、添加子设备</strong></p>
<p>为了保证安全,同样要求网关在线时，才能够绑定子设备。子设备可以支持批量绑定。</p>
<p><img alt="DM_gateway3" src="../../pic/features/DM_gateway3.png" /> </p>
<p>客户端为微信时，操作流程是一样的。</p>
<p><strong>3、设备分享</strong>
第一个绑定的用户绑定成功后成为该设备的管理员，可以通过生成设备分享二维码或者邀请其他用户的方式分享设备的使用权。对于网关型设备，管理员可以分享网关，此时网关以及下面所有的子设备的使用权全部分享出去；也可以只分享子设备，此时被分享用户只有子设备的使用权。</p>
<p><em>1、管理员分享</em></p>
<p><img alt="DM_gateway4" src="../../pic/features/DM_gateway4.png" /> </p>
<p><em>2、管理员邀请</em></p>
<p><img alt="DM_gateway5" src="../../pic/features/DM_gateway5.png" /> </p>
<p>对于使用二维码分享方式分享设备使用权的，可以自己定义二维码有效期，过了有效期再扫描的时候也不能够获得设备使用权。</p>
<p>对于使用邀请方式分享的，要求被邀请人已经注册。</p>
<p>客户端为微信时，只能够使用“管理员分享”的模式分享设备。</p>
<p>开发指导参考：</p>
<p><a href="../../develop_guide/android/#_16">开发指导-安卓-网关型设备管理</a></p>
<p><a href="../../develop_guide/iOS/#_18">开发指导-iOS-网关型设备管理</a></p>
<p><a href="../../develop_guide/wechat/#_15">开发指导-微信-网关型设备管理</a></p>
<p><a href="../../develop_guide/device/#_7">开发指导-设备(嵌入式系统)-设备绑定管理</a></p>
<h2 id="home">home模型</h2>
<h3 id="_9">基本介绍</h3>
<p>考虑到用户管理的设备量变多的时候的分组管理需求，AbleCloud开发了home模型。</p>
<p>AbleCloud的home模型在权限管理上继承之前的WiFi设备以及网关型设备，该权限模型和HomeKit的权限管理方式一致——基于管理员的权限管理。</p>
<p>home模型的组层次如下图所示：</p>
<p><img alt="home" src="../../pic/features/home.png" /> </p>
<p><strong>说明：</strong></p>
<ul>
<li>home是有管理权限的组。创建home的人成为该home的管理员。类似于网关，home的管理员是下面所有设备的管理员。管理员可以将home授权给普通用户，这时候，home下面的所有设备都授权给该用户。Home的管理员只能够将新设备或者自己有管理权限的设备放到home里。普通用户不能够在home中添加或者删除设备。</li>
<li>home下面可以创建room，room只是方便管理并不能进行权限的授予和取消。</li>
<li>home和room下面都可以有设备。这套组模型向下兼容WiFi设备和网关型设备，也就是说home和room下面可以是WiFi设备也可以是网关型设备，WiFi型设备和网关型设备的设备管理的接口同样都可以使用。同时，设备端固件不需要进行任何改动。</li>
<li>任何设备和room都有标识其所在home的属性。Home可以列出其下面有的所有room和home下的所有设备。room也可以列出该room下的设备。</li>
<li>可以先绑定设备再将设备添加到home中，但是建议先创建home，然后将新的设备添加到home中。</li>
<li>往home中添加的设备必须是以下两种之一：种是没有被绑定的设备(包括新设备或者被管理员解绑的设备);还有一种是该home管理员的设备。</li>
<li>创建room时必须指定其所属的home。将设备放入room前必须将设备先放入home。</li>
</ul>
<p>需要单独说明的是，Home模型只是设备权限管理的模型，与用户的自定义场景设置没有关系。例如，管理员自定义了一个场景为“离家模式”，该场景下会关闭所有屋子的灯，当新用户加入家庭时，并不能获取到管理员定义的该场景。</p>
<h3 id="_10">建议的交互流程</h3>
<p><img alt="home_wifi" src="../../pic/features/home_wifi.png" /> </p>
<p><strong>1、设备为独立设备（WiFi）</strong></p>
<p><em>（1）创建Home</em></p>
<p>Home是有权限管理的，可以将Home分享给其他人，则被分享的人对Home下面的所有Room和Room里的设备都有使用权，但没有管理权。将Home分享给其他人也可以看作将其他人添加到Home里，这里从APP上可以显示为添加成员到Hoom。</p>
<p><em>（2）创建Room</em></p>
<p>Room没有权限管理，Home的管理员不能把Room分享给其他人，只能分享Home和设备。对Home有使用权的人就能看到Room和Room下面的设备。</p>
<p><em>（3）添加设备到Room</em></p>
<p>(走完整的绑定WiFi设备的流程，参考<a href="../functions#_3">设备管理-独立设备</a>)</p>
<p>创建好Room后，可以将新的设备添加到Room。用户首先选择Room，接着选择添加设备到Room，然后配置设备WiFi密码，最后添加设备到Room。具体实现时，是先添加设备到Home，然后将设备从Home移动到Room。</p>
<p><strong>2、设备为网关型设备</strong></p>
<p>当设备为网关型设备时，一般一个Home有一个网关，网关下面有多个子设备，子设备分布在不同的Room。此时，建议的交互流程是：</p>
<p><img alt="home_gateway" src="../../pic/features/home_gateway.png" /> </p>
<p><em>（1）创建home</em></p>
<p>同WiFi设备相同</p>
<p><em>（2）创建room</em></p>
<p>同WiFi设备相同</p>
<p><em>（3）添加网关到家庭</em>（走和绑定WiFi设备一样的绑定网关的流程）</p>
<p>当一个Home中只有一个网关时，建议采用此种流程。网关添加到Home中后，再将各个子设备添加到Room。当家中有多个网关时，也可以采用此种流程，只是将子设备添加到Room的时候，需要选择添加到哪个网关。</p>
<p><em>（4）添加子设备到房间</em>（走和网关添加子设备一样的流程） </p>
<p>选择Room，然后进入网关型设备的添加子设备流程。具体实现是先添加子设备到网关，然后移动子设备到Room。</p>
<p><strong>3、微信</strong></p>
<p>由于微信绑定设备是要先扫描设备的二维码的，所以，流程与app会有不同。因此建议的流程是：</p>
<p><img alt="home_wechat" src="../../pic/features/home_wechat.png" />   </p>
<ol>
<li>扫描二维码绑定设备的流程和微信绑定WiFi设备的流程相同,参考<a href="../functions#_3">设备管理-独立设备</a></li>
<li>扫描第二、三、四个设备的二维码，绑定设备</li>
<li>进入设备管理页面，创建家庭（home）</li>
<li>在家庭（home）下创建房间</li>
<li>将已经绑定的设备移动到房间</li>
</ol>
<p><strong>人员管理</strong></p>
<p>AbleCloud支持两种设备分享模式。一种是通过分享码，普通用户通过扫描分享码获得使用权；一种是邀请模式，管理员填写普通用户的注册帐号，邀请该用户使用设备。</p>
<p>对于home模型，采用同样的模式。管理员可以将home分享给普通用户：即管理员生成分享码，普通用户扫描加入home；也可以邀请普通用户加入home的成员列表，即管理员将普通用户的帐号添加进home。只有home能够设定权限，即只能够分享home或者邀请普通用户加入home。</p>
<p>开发指导参考：</p>
<p><a href="../../develop_guide/android/#home">开发指导-安卓-home模型</a></p>
<p><a href="../../develop_guide/iOS/#home">开发指导-iOS-home模型</a></p>
<p><a href="../../develop_guide/wechat/#home">开发指导-微信-home模型</a></p>
<h2 id="_11">设备扩展属性</h2>
<p>AbleCloud的基本设备属性只包括设备名称。如果厂商需要用户在APP等客户端中填写更多和设备关联的信息，如设备关联手机号、家庭住址、地理位置等，就需要用到设备的扩展属性。</p>
<p>为了简化设备绑定流程，一般设备扩展属性可在设备绑定完成后补充填写，在绑定过程中不填写。</p>
<p>若要使用设备的扩展属性，首先需要在产品管理中进行定义。</p>
<p>产品管理中选择要管理的产品，在产品属性页面创建该产品的设备的扩展属性。如下图所示：</p>
<p><img alt="device_appendix" src="../../pic/features/device_appendix.png" /> </p>
<p>其中：属性标识是该属性的唯一标识，在SDK的扩展属性接口中需要作为参数。</p>
<p>开发指导参考：</p>
<p><a href="../../develop_guide/android/#_20">开发指导-安卓-设备扩展属性</a></p>
<p><a href="../../develop_guide/iOS/#_22">开发指导-iOS-设备扩展属性</a></p>
<p><a href="../../develop_guide/wechat/#_21">开发指导-微信-设备扩展属性</a></p>
<h1 id="_12">云端通信</h1>
<p>云端通信指的是APP到云端、设备到云端的通信。分别对应下图中的绿色和紫色线所标注的数据流。</p>
<p><img alt="cloudcommunication" src="../../pic/features/cloudcommunication.png" /> </p>
<p>AbleCloud支持三种数据格式，分别是JSON、KLV和二进制：</p>
<ul>
<li>
<p>JSON格式，适合MCU支持JSON解析的设备或者使用安卓系统的设备。</p>
</li>
<li>
<p>KLV格式，采用AbleCloud自定义的协议，与二进制码流类似，节省设备的运算资源，具体协议格式参见：<a href="../../reference/device/#klv">reference-设备-KLV协议介绍</a>；</p>
</li>
<li>二进制，这种数据格式AbleCloud不能够解析，因此部分可视化功能不可用，如“设备虚拟”。</li>
</ul>
<p><font color="red"> 注:</font>对于网关型设备，AbleCloud并不关心子设备和网关的具体通信协议和数据格式。云端能够看到的是网关上报的子设备的数据格式。例如，网关是安卓设备、子设备计算能力比较弱数据格式是二进制，但是安卓网关能够将子设备的数据解析然后重新打包成JSON格式和云端进行交互，那么在云端管理后台设置的时候，子设备的数据格式也需要设置成JSON格式。</p>
<p>无论采用JSON、KLV还是二进制为了统一，建议安卓、iOS、微信，全部采用有符号格式。比如一个十进制整数，当小于127时可以采用8bit数据表示，当大于127小于256时，就必须用16bit表示了。当前支持的交互数据类型包括：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>描述</th>
<th>范围</th>
</tr>
</thead>
<tbody>
<tr>
<td>int8</td>
<td>8位有符号整形</td>
<td>-128~127</td>
</tr>
<tr>
<td>int16</td>
<td>16位有符号整形</td>
<td>-32768~32767</td>
</tr>
<tr>
<td>int32</td>
<td>32位有符号整形</td>
<td>-2^31~2^31-1</td>
</tr>
<tr>
<td>int64</td>
<td>64位有符号整形</td>
<td>-2^63~2^63-1</td>
</tr>
<tr>
<td>float32</td>
<td>32位浮点数</td>
<td>32位浮点数的范围</td>
</tr>
<tr>
<td>float64</td>
<td>64位浮点数</td>
<td>64位浮点数的范围</td>
</tr>
<tr>
<td>string</td>
<td>字符串</td>
<td>长度小于450字节</td>
</tr>
<tr>
<td>stream</td>
<td>文件或者数据流，需要厂商写自定义服务进行处理</td>
<td>单个包长度小于450字节</td>
</tr>
</tbody>
</table>
<p>云端通信的详细通信类型见下图：</p>
<p><img alt="cloudintaraction" src="../../pic/features/cloudinteraction.png" /> </p>
<h2 id="_13">发送消息到设备</h2>
<p>客户端的指令接口为sendToDevice。云端直接将消息透传，发送到设备。如果不需要存储每次调用接口发送的内容，直接调用SDK接口即可。如果需要存储每次调用该接口发送的内容，需要开发相关的存储服务。</p>
<p>根据网络条件不同，会有或长或短的响应时间。因此，我们建议，对于控制类指令，当用户控制指令发送以后APP即显示已经控制成功，当设备响应结果返回时，再根据返回结果修正APP状态：如果确实控制成功了，则不需要再给出提示，如果没有控制成功，修改APP相应显示为没有控制成功的状态并给出控制失败的提示。例如，APP远程控制一个插座的打开，当用户在APP上点击打开按钮的时候，APP上的按钮直接显示操作成功，以给用户及时的响应。如果APP远程打开插座成功，则APP不再有任何变化和提示；如果APP远程打开插座失败了，则APP页面上给出打开插座失败的提示，并把APP上显示的开关状态变为关闭。如果用户点击完打开就退出APP了，这时候如果打开失败了，建议给用户发送打开失败的推送通知。</p>
<p>对于APP请求设备和云端数据，如果是要设备返回相关数值的，网络环境比较差的情况下可能会有等待时间，建议APP在等待设备返回结果的时候给出相应的<strong>等待</strong>提示。</p>
<h2 id="_14">发送消息到服务</h2>
<p>设备管理、帐号管理等，都是AbleCloud提供的通用云端服务，因此直接调用相关接口即可实现对应的功能。除此之外，智能硬件厂商通常还会开发自己的后端服务，这些后端服务通常也运行在AbleCloud提供的PaaS平台上，因此客户端还会和自定义的服务通信。</p>
<p>客户端到服务的指令接口为sendToService。云端需要写UDS服务，对客户端发来的指令进行解析和响应。例如，对于一个空气检测仪，APP需要获取过去三天的历史数据。用户需要开发对应UDS服务，收到APP的请求后，在存储服务中检索出过去三天的历史数据，作为返回值返回给APP。</p>
<p>同时，为了支持商城等展示页面，AbleCloud也支持匿名访问服务，匿名访问的接口为sendToServiceWithoutSign，对应的UDS中使用handleAnonymousMsg处理匿名用户的请求。</p>
<h2 id="_15">实时消息同步</h2>
<p>当APP打开时，可以订阅设备实时上报的消息。这时候，不需要APP刷新，设备端有新的数据或者状态变化的时候，APP上对应的页面的数据或者状态就会刷新。</p>
<p>AbleCloud的实时消息同步是和存储相关的。若要显示设备实时上报的消息，首先需要在管理后台的存储管理中定义需要watch的存储列。需要开发UDS服务，将设备上报的数据写入到存储中。</p>
<p>当APP上采用实时消息同步显示设备上报的数据时，在网络环境比较差的情景下，数据显示可能会不及时。此时，如果用户无法看到数据变化同时也不能进行任何操作，会导致用户焦虑。所以，建议对于实时显示数据的页面设计可以手动刷新数据的功能。这样，当实时数据显示没有变化时，用户可以手动刷新。</p>
<p>一般来讲，当APP没有打开的情况下，对于需要定时上报数据的设备也一般不建议设备高频次快速上报数据。但是在APP打开的情况下开启实施消息同步时，为了用户能快速及时的看到设备的数据和状态的变化，需要将设备的上报时间间隔变小。然后，在APP退出或者离开监控的页面的时候，再把设备的上报间隔变回原来的值。因此在设备开发时，需要开发调整上报频率的功能；在APP开发时，需要在进入需要实时监控设备状态变化的页面时给设备发一条指令，通知设备快速上报数据，当APP离开该页面的时候，再发一条指令，通知设备使用正常的上报间隔。</p>
<p><strong>开发指导请参考：</strong></p>
<p><a href="../../develop_guide/android/#_23">开发指导-安卓-云端通信</a></p>
<p><a href="../../develop_guide/iOS/#_25">开发指导-iOS-云端通信</a></p>
<p><a href="../../develop_guide/wechat/#_24">开发指导-微信-云端通信</a></p>
<h2 id="_16">设备上报消息</h2>
<p>设备可以在定时或者根据外界条件触发的情况下将设备数据和状态主动上报到云端。其中上报的消息号(message code)必须大于等于200。</p>
<h2 id="_17">设备接收云端指令</h2>
<p>设备接收的云端指令分为两种:控制指令和查询指令。</p>
<p>控制指令是控制设备，并返回执行结果，其中控制指令的消息号必须大于64且小于200。</p>
<p>查询指令是查询设备状态和数据，并返回查询结果，其中查询指令的消息号必须大于64且小于200。</p>
<p>设备接收到云端指令必须返回响应结果,控制指令和查询指令的返回值均不需要填写消息号。</p>
<p>开发指导请参考：</p>
<p><a href="../../develop_guide/device/#_15">开发指导-设备-云端通信</a></p>
<h1 id="_18">局域网通信</h1>
<p>局域网通信是指设备和设备、APP和设备在一个局域网内时，不通过云端直接进行通信。 </p>
<p>局域网通信能够保证在外网断开的情况下设备的正常使用，提供设备之间的高速访问能力及关联控制功能。</p>
<p>对于希望统计用户行为和设备数据的厂商，建议在云端和局域网都在线的情况下，用户的交互和设备的数据上报仍然走云端。只有在外网断掉，只有局域网的时候，才切换到只使用局域网的状态。因为这样才能够完整记录用户的行为数据和设备的历史数据，使数据分析的结果更可靠。</p>
<p>AbleCloud提供了非常简单的接口实现设备的局域网发现和状态获取以及控制。</p>
<p>如果要求用户进入到局域网以后，APP和设备的交互能够自动切换到局域网模式，而不再通过云端，那么对于用户来讲，最好的交互是完全感受不到这种切换。</p>
<p>我们提供的接口能够帮助厂商直接获取到当前设备的在线状态：云端和局域网在线、云端在线、局域网在线、云端和局域网都不在线。因此APP开发人员可以根据设备的在线情况调用相关的处理接口，是用户感受不到网络的切换。</p>
<p><strong>开发指导请参考：</strong></p>
<p><a href="../../develop_guide/android/#_28">开发指导-安卓-云端通信</a></p>
<p><a href="../../develop_guide/iOS/#_30">开发指导-iOS-云端通信</a></p>
<p><a href="../../develop_guide/device/#_20">开发指导-设备-局域网通信</a></p>
<p><strong>安全机制</strong></p>
<p>局域网本身并不是可信网络，并不能依赖于局域网的安全机制，所以不能够认为接到同一个局域网的设备和用户就互相有权限。AbleCloud在局域网中采用基于localAccessKey的认证机制。只有设备之间、应用和设备之间有相同的localAccessKey的时候才能够进行局域网通信。localAccessKey由云端发放，在特定场景下进行更新。</p>
<p>设备绑定、用户分享时，localAccessKey的获取流程如下：</p>
<ol>
<li>设备连接云端激活。</li>
<li>第一个用户绑定设备成为管理员，云端向设备和管理员发送相同的localAccessKey。</li>
<li>管理员将设备删除时,云端会重置设备的localAccesslkey。所有用户启动APP获取设备列表的时候，SDK会自动更新localAccesskey,若设备已删除，则localAccesskey自动失效。</li>
<li>其他用户绑定设备后从云端获取设备列表时SDK会自动从云端获得localAccessKey。</li>
<li>管理员将某用户解绑，该用户启动APP到云端获取设备列表时，设备列表中不再存在已经被解绑的设备，同时localAccessKey失效。</li>
</ol>
<p>localAccessKey对开发者不可见，由SDK自动维护。</p>
<h1 id="_19">定时任务</h1>
<p>AbleCloud支持两种类型的定时任务。一种是云端定时，即用户将定时任务发送到云端，到达用户设定的时间后，云端将设备操作指令下发给设备。一种是设备定时，用户通过云端将指令发送给设备，设备通过自己的计时器进行定时，到达触发时间之后，设备自己执行。</p>
<p>对于云端定时，优点是准确，云端采用标准网络时间，不会产生误差；缺点是，断网情况下，任务不能够执行。
对于设备端定时，优点是，设备断网之后仍可执行；缺点是时间准确度不如云端高。但是如果设备段采用的是高精度晶振，误差不会超过几秒钟。</p>
<p>AbleCloud对部分厂商的WiFi模块进行了优化，使WiFi模块支持设备端定时，因此不需要MCU进行该功能开发也可以使用设备端的定时功能。
需要单独说明的是，对于设备端的定时，如果设备掉电了，再次上电之后没能连接到云端，定时任务失效。</p>
<p>AbleCloud的定时任务功能支持单次任务、按天重复、按星期重复，对于云端定时，还支持按月重复。对于APP端的开发，开发者只需要调用相关的接口，将任务类型和执行的指令内容发送到云端即可。对于使用云端定时和使用AbleCloud支持设备端定时的WiFi模块的的设备，设备上不需要针对定时任务做任何开发，因为从设备端看来只是执行了一条普通指令。</p>
<p>APP端建议的用户交互请参考手机的闹钟设定方法。只是在闹钟设定的基础上增加对设备操作的设定。</p>
<p>开发指导请参考：</p>
<p><a href="../../develop_guide/android/#_29">开发指导-安卓-定时任务</a></p>
<p><a href="../../develop_guide/iOS/#_31">开发指导-iOS-定时任务</a></p>
<p><a href="../../develop_guide/wechat/#_28">开发指导-微信-定时任务</a></p>
<h1 id="ota">OTA</h1>
<p>OTA（Over－the－Air Technology），即空中下载技术。</p>
<p>在智能硬件领域，当设备固件需要升级的时候，可以借助OTA实现远程升级。</p>
<p>对于蓝牙设备，OTA需要先将固件下载到手机上，APP启动后连接设备，然后将手机中的固件下发到蓝牙设备进行升级。</p>
<p>需要进行OTA时，首先在管理后台提交对应的OTA固件，然后云端会将固件提前下发到设备。</p>
<p>对于非蓝牙设备，AbleCloud提供三种OTA模式：</p>
<ul>
<li>一种是静默升级；</li>
<li>一种是需要用户确认的升级。</li>
<li>一种是强制升级。</li>
</ul>
<p>对于静默升级，不需要任何用户的交互操作，在厂商管理后台设定升级版本、升级时间，连接到云端的设备，云端会发送OTA固件，然后设备自动完成升级。</p>
<p>对于需要用户确认的升级，厂商在管理后台提交新的固件版本后，云平台会把固件提前下载到设备当中，但是不进行升级操作，而是当用户启动APP的时候，给用户一个升级提醒，由用户来确认是否升级。</p>
<p>对于强制升级，厂商在管理后台提交新的固件版本后，云平台会把固件提前下载到设备当中，当用户启动APP时，会收到一个升级提醒，但是用户不能点击取消，只能够确定。</p>
<p>对于用户确认的升级，AbleCloud提供两种场景的支持：</p>
<ul>
<li>一种是用户收到升级通知后，选择“当前不升级”，下次启动APP的时候，同样还会收到升级固件的通知；</li>
<li>一种是用户启动APP后，选择“忽略当前版本”，则以后再启动APP的时候，不会再收到该版本的固件更新通知，直到有更新版本的固件发布。</li>
</ul>
<p><font color="red">注</font>:对于操作系统为安卓的设备,OTA时还可以设定地域范围。</p>
<p>开发指导参考：</p>
<p><a href="../../develop_guide/android/#ota">开发指导-安卓-OTA</a></p>
<p><a href="../../develop_guide/iOS/#ota">开发指导-iOS-OTA</a></p>
<p><a href="../../develop_guide/wechat/#ota">开发指导-微信-OTA</a></p>
<h1 id="_20">推送</h1>
<p>与实时消息不同，推送一般指的是用户收到的通知栏提醒。</p>
<p>AbleCloud的消息推送目前集成的是<a href="http://www.umeng.com/">友盟推送</a>。</p>
<p>AbleCloud提供三种类型的推送，一种是厂商在后台定义的群发通知， 一种是和设备状态相关的消息推送，一种是和用户相关的消息推送。</p>
<p>对于群发通知，开发者直接去友盟的后台进行消息设定即可，不需要在AbleCloud的平台进行配置。</p>
<p>对于和设备状态相关的推送以及和用户状态相关的推送，首先需要在友盟和AbleCloud的后台进行相关的配置。配置完成后，开发者需要开发对应的云端UDS服务。</p>
<p><strong>和设备状态相关的推送</strong></p>
<p>和设备相关的推送分为两种，一种是厂商默认设备状态变化时就给用户发送推送通知，比如门磁检测到门窗开关时就给用户发送通知，用户可以设定该推送消息关闭或者打开；一种是用户自定义设备阈值，设备状态触发该阈值时，给用户发送通知，如设定一个烧水的壶当水温从高往低变到50摄氏度时发送通知。</p>
<p>用户在APP打开状态下收到通知时可以从通知栏弹出通知消息，用户点击后进入到相关页面，也可以不是从通知栏弹出推送，而是直接在APP中弹出消息框。</p>
<p>用户在息屏或者APP没有在前台的状态下收到通知时，从通知栏弹出推送，点击通知可以进入到相关页面。</p>
<p><strong>和用户状态相关的推送</strong></p>
<p>一个典型的应用场景是，某用户被管理员解绑后收到被解绑通知。这种类型的推送厂商根据实际需求开发。</p>
<p>安卓、iOS和微信实现推送的方式不同，具体开发请参考开发指导：</p>
<p><a href="../../develop_guide/android/#_39">开发指导-安卓-推送</a></p>
<p><a href="../../develop_guide/iOS/#_41">开发指导-iOS-推送</a></p>
<p><a href="../../develop_guide/wechat/#_38">开发指导-微信-推送</a></p>
<h1 id="_21">短信通知</h1>
<p>短信通知是只厂商通过短消息像用户发送验证码、报警等消息的通知方式。</p>
<p>对于验证类的短信，通过调用客户端的SDK的帐号管理接口中的sendVerifyCode接口可以实现发送请求。如开发者需要给用发送注册验证码，直接在APP上调用sendVerifyCode接口，填入用户的手机号和模版号即可。其中模版号需要在管理控制台中的短信管理中获得。</p>
<p>对于其他类型的短息通知发送请求，只能够在UDS中发起。调用的UDS的接口为ACSmsMgr接口中的sendSms。同样，需要在管理控制台中获得短信模版。</p>
<h1 id="_22">文件存储</h1>
<p>文件存储是AbleCloud提供的非结构化存储功能。可以用来存储头像、文件等大的数据块。
文件存储由于占用空间和带宽比较大，因此费用需要单独核算。具体请来电咨询我司商务。
目前文件存储功能只在客户端提供接口，设备端还不提供文件存储功能。</p>
<p>使用方法请参考</p>
<p><a href="../../develop_guide/android/#_43">开发指导-安卓-文件存储</a></p>
<p><a href="../../develop_guide/iOS/#_45">开发指导-iOS-文件存储</a></p>
<h1 id="_23">第三方云对接</h1>
<p>为了方便硬件厂商使用其它云厂商的已有资源，如终端优势，渠道优势等，AbleCloud实现了和其它云厂商的对接。这样一来，硬件厂商已经接入AbleCloud的硬件很方便就能和第三方打通，并且硬件厂商可以同时拥有多个云厂商的资源，不用再一家一家的实现对接，因为这些和第三方云的对接工作，已经由AbleCloud完成了。 当前，AbleCloud实现了和微信、京东云的对接，后续会对接更多的第三方云。</p>
<h2 id="_24">微信</h2>
<p><a href="http://iot.weixin.qq.com/">微信硬件平台</a>是微信为服务号提供的物联网解决方案。设备功能允许硬件设备厂商通过服务号将用户与其拥有的智能设备相连。通过微信硬件平台规定的连接协议，各种智能设备如蓝牙设备、WiFi设备和其他移动网络设备都能方便的接入微信，完成设备、人、服务三者的连接。</p>
<p>AbleCloud打通了和微信硬件平台的接入，实现了双方的云端对接，开启了微信硬件开发的全新模式。在该模式下，结合AbleCloud提供的PHP SDK，厂商可以在其微信服务号里实现和native app几乎一样的智能硬件功能特性，如设备绑定、解绑、网关和网关子设备的绑定、解绑以及Home模型的使用，并且保证足够的安全性。</p>
<p>普通用户只需要用微信扫描设备二维码，就能实现对设备的绑定，从而实现对设备的控制。</p>
<p>在AbleCloud与微信对接的合作模式中，双方共同维护用户信息、设备信息，以及用户与设备的绑定关系。</p>
<p>AbleCloud则提供了维护WIFI设备的工作状态、与WIFI设备远程通信、分组管理WIFI及蓝牙设备、管理网关设备、管理并实施设备OTA等与设备管理直接相关的功能。</p>
<p>对于蓝牙设备，则由微信客户端负责与设备的具体通信。</p>
<p>为帮助厂商开发支持硬件功能的微信公众号，AbleCloud提供了PHP及Java语言的SDK。厂商的微信公众号主要通过HTML5页面及公众号菜单等界面向用户提供交互功能。</p>
<p>具体的开发请参考：<a href="../../develop_guide/wechat/">开发指导-微信</a></p>
<h1 id="_25">名词解释</h1>
<h2 id="_26">通用</h2>
<ul>
<li>
<p><strong>设备绑定</strong>：用户通过APP端对设备进行绑定，第一个绑定的人成为管理员，其他人只能够通过管理员的分享或者邀请绑定设备。只有通过绑定的用户才能控制设备。</p>
</li>
<li>
<p><strong>设备解绑</strong>：管理员解绑设备相当于删除设备，所有和该设备的绑定关系都删除。设备从逻辑上变为一台新的设备，所有注册用户可以绑定，且绑定后不会看到该设备的历史数据。普通用户进行设备解绑只是放弃对该设备的使用权。</p>
</li>
<li>
<p><strong>设备分享</strong>：管理员将设备的使用权分享给其他用户，一般模式下只有管理员才能够分享设备。设备的普通用户不能分享该设备。</p>
</li>
</ul>
<h2 id="_27">产品定义相关</h2>
<ul>
<li>
<p><strong>主域</strong>：Major Domain，是公司层面的概念，AbleCloud为每一个使用AbleCloud平台的公司分配一个唯一主域，如Google。</p>
</li>
<li>
<p><strong>产品子域</strong>：SubDomain，是公司的某一款产品，如Glass。在管理后台创建产品时需要填入相应的产品子域名称。</p>
</li>
<li>
<p><strong>产品</strong>：和产品子域等同的概念。一款产品包括产品名称和产品型号，如空调XXL。一款产品就是一个子域。对于网关型设备，网关和子设备分别要独立创建产品。因为不同的子设备看作是不同的产品。</p>
</li>
<li>
<p><strong>设备</strong>：Device，即厂商生产的具体的一台设备。只有被绑定的设备才能被控制。在没有指明是“网关”还是“子设备”时，Devie可以表示任何有设备ID的独立设备、网关、子设备。一台设备一定是属于某款产品的。</p>
</li>
<li>
<p><strong>网关</strong>：Gateway,是指自身具有联网能力，且可以连接控制其他设备的设备，如Zigbee网关、蓝牙网关等。网关下面的设备我们成为子设备。网关可以有独立的功能也可以纯粹作为一个协议转换的通道。</p>
</li>
<li>
<p><strong>子设备</strong>：Subdevice,指通过网关和云端进行通信的设备。子设备和网关有隶属关系，对网关有权限的用户也对子设备有权限。子设备可以单独进行权限管理。</p>
</li>
<li>
<p><strong>数据点</strong>：指设备的功能点。在创建产品的时候，需要在云端创建该产品的数据点。比如开发一款空调，该空调有设定开关、温度、模式三个功能，则需要创建对应的三个数据点。</p>
</li>
<li>
<p><strong>数据包</strong>：数据点的集合，需要在管理后台创建。一个数据包中有一个或者多个数据点，用作在APP和设备之间进行消息传输。每一个数据包有一个message code，作为不同数据包的区分，也作为该数据包功能的标识。比如，每次控制空调时，都是把温度和模式一起传输，则创建一个数据包，分配一个message code（这里设定为80）。然后在message code里添加“温度”和“模式”两个数据点。因此，每次设备收到message code为80的消息，就知道该消息是要设定温度和模式。</p>
</li>
</ul>
<h2 id="_28">服务相关</h2>
<ul>
<li>
<p><strong>服务</strong>：即开发者开发的具体Service，如Controller。一个服务，必须属于某一主域、子域。</p>
</li>
<li>
<p><strong>版本</strong>：为了支持服务升级、回滚等，AbleCloud支持为同一服务创建多个版本。版本由Major Version、Minor Version、Patch Version来标示。</p>
</li>
<li>
<p><strong>云端通用服务</strong>：由AbleCloud提供的云服务，如帐号管理、设备管理。</p>
</li>
<li>
<p><strong>自定义服务</strong>：由厂商基于AbleCloud的云服务引擎开发的自定义后端服务，也记为User Defined Service（UDS）。</p>
</li>
</ul>
<h2 id="_29">帐号相关</h2>
<ul>
<li>
<p><strong>管理员</strong>：对设备有终极权限的用户。可以对设备进行绑定、解绑、分享、添加子设备、删除子设备等操作，还可以将设备对普通用户进行授权管理。</p>
</li>
<li>
<p><strong>普通用户</strong>：即智能设备的终端用户，对设备有查看和控制权限，但是没有管理权限。</p>
</li>
<li>
<p><strong>开发者</strong>：产品的开发者。在AbleCloud的Web页面完成注册后可以在AbleCloud的后台进行产品的开发和管理。免费使用AbleCloud提供的各种开发工具和源代码。</p>
</li>
</ul>
<h2 id="_30">设备相关</h2>
<ul>
<li>
<p><strong>Smartconfig</strong>：是德州仪器开发的针对智能设备的APP端SDK。它支持将家庭WiFi的SSID以及密码通过加密后广播给智能设备，智能设备收到后自动完成配置并连上WiFi。 </p>
</li>
<li>
<p><strong>Ablelink</strong>：AbleCloud对Smartconfig协议进行封装然后添加云端握手和本地局域网广播后的协议。</p>
</li>
<li>
<p><strong>流量控制</strong>：对带宽等资源进行合理分配，防止资源抢占和拥堵。</p>
</li>
<li>
<p><strong>握手认证</strong>：采用优化后的加密算法，提升设备的安全性。</p>
</li>
<li>
<p><strong>局域网直连</strong>：让手机可以在局域网内直接连接和控制设备。</p>
</li>
<li>
<p><strong>命令转发</strong>：采用AbleCloud优化的传输协议，将APP的对设备的指令通过云端发送到设备。</p>
</li>
<li>
<p><strong>数据上报</strong>：基于AbleCloud和设备的安全长链接通路，设备将数据上报到云端然后云端推送给用户或厂商自定义服务。</p>
</li>
<li>
<p><strong>设备物理ID</strong>：简称设备ID，设备出厂时，由厂商生成的ID，通常为16个字符的字符串。可以使用每台设备单独烧制的方式生成，也可以使用设备的MAC地址等信息生成。</p>
</li>
<li>
<p><strong>设备逻辑ID</strong>：设备在激活后被管理员绑定时生成的ID，通常为长整数。客户端（安卓、微信、iOS）对设备的控制和管理都使用逻辑ID。</p>
</li>
<li>
<p><strong>设备密钥</strong>：设备和云端交互的时候，在握手阶段需要进行密钥验证。握手阶段可以支持RSA密钥和AES密钥认证两种方式。RSA密钥算法稍微复杂，但是可以支持运算和设备的双向认证，安全性最高。AES密钥运算相对简单，但是无法对设备的真伪进行验证。也就是一旦密钥泄漏，攻击者既可以伪造设备又可以伪造云端。</p>
</li>
</ul>
<p>对于使用RSA认证，云端需要有设备的公钥；对于AES认证，云端需要提前存储设备端使用的AES密钥。无论使用哪种认证方式，AbleCloud都支持两种密钥管理方式。一种是该产品的所有设备使用相同的密钥；一种是该产品的每台设备有独立的密钥。对于第一种，AbleCloud可以直接生成密钥，设备开发人员将和云端对应的密钥烧到设备固件中即可。对于第二种，AbleCloud提供密钥生成工具，可以生成和设备物理ID一一对应的密钥。将密钥文件上传到云端后，设备才能够和云端通信握手成功。</p>
<ul>
<li>
<p><strong>设备公钥</strong>（RSA256）：32字节的整数，与设备私钥是一对。在设备批量出货前需要在管理后台提交设备公钥。在设备首次连接云端握手时，AbleCloud服务器用该公钥来加密给设备发送的消息。可以一款产品设置一对公钥私钥。对于安全性要求高的产品，也可以每台设备一个独立的公私钥对。</p>
</li>
<li>
<p><strong>设备私钥</strong>（RSA256）：112字节的整数（需要和设备公钥保持匹配）。</p>
</li>
<li>
<p><strong>设备版本</strong>：设备固件的版本信息，长度为4个字节。</p>
</li>
<li>
<p><strong>设备域信息</strong>：设备所属产品的domainID和subdomianID，长度8字节（两个字节的DomainID加上6个字节的SubDomainID）。</p>
</li>
</ul>
<h2 id="_31">开发调试相关</h2>
<ul>
<li>
<p><strong>设备调试</strong>：一般指开发者对设备功能进行调试。AbleCloud云端提供了辅助调试的工具，称作设备调试。该工具可以将设备上的数据通过网页直接展示出来。方便在APP还没有开发的阶段对设备的功能进行调试。用户可以在网页上查看数据，还可以模拟APP在网页上给设备发送指令。</p>
</li>
<li>
<p><strong>虚拟设备</strong>：指云端虚拟出一个用户已经定义的产品的设备。方便在设备还没有开发完成时对APP的调试。虚拟设备可以模拟真实设备上报数据，也可以显示APP发来的指令。</p>
</li>
</ul>
<h1 id="klv">KLV协议介绍</h1>
<p>KLV是一种比json更轻量级的类json数据交换格式，适合在低处理能力的嵌入式设备上运行。KLV采用了流格式，KLV中key必须是数字，可以跟简单json进行转换，只是需要将json中的不同类型的key映射成KLV的数字的key。因此，使用KLV格式的数据，一方面降低了设备端运算压力另一方面，云端和APP端可以像JSON一样解析数据的具体内容。这样，在云端定义了KLV格式的数据点之后，大数据分析引擎就可以对设备的具体各个功能点的使用情况进行统计分析了。</p>
<p>KLV数据格式如下图所示：</p>
<p><img alt="device_KLV1.png" src="../../pic/features/device_KLV1.png" /></p>
<p>KLV数据格式包含四部分：键值（Key），数据类型，长度（Length），数值（Value）。</p>
<p>键值：key使用8个bit的数字表示，范围从0～255，可以表示256个不同的key。如果产品的数据格式选择为KLV，在管理后台定义数据点时，需要填写数据点的key值。</p>
<p>数据类型：使用第二个字节的低5个bit用于表示数值的数据类型，高3个bit预留不用，约定：</p>
<ul>
<li>0x00：无效，只有key，没有value，适用于不需要参数的控制，比如上报当前温度。</li>
<li>0x01：布尔型（占用8bit数值表示，只使用第一个bit）</li>
<li>0x02：8位整型</li>
<li>0x03：16位整型（网络字节序，用户无须转换）</li>
<li>0x04：32整型（网络字节序，用户无须转换）</li>
<li>0x05：64整型（网络字节序，用户无须转换）</li>
<li>0x06：浮点型（32位，网络字节序，用户无须转换）</li>
<li>0x07：双精度型（64位，网络字节序，用户无须转换）</li>
<li>0x08：字符串</li>
<li>0x09：二进制</li>
<li>0x0A：KLV类型[保留]</li>
</ul>
<p>数据长度：占用两个字节（网络字节序，用户无须转换），数据长度是可选参数，当数据类型是无效，布尔，整形，浮点型时，不需要数据长度，根据数据类型就可以知道数据长度，约定：
无效数据类型数据长度为0，即第三个字节是下一个KLV结构。</p>
<ul>
<li>布尔型数据长度为1，占用其后一个字节。</li>
<li>8位整形数据长度为1，占用其后一个字节。</li>
<li>16整形数据长度为2，占用其后两个字节。</li>
<li>32整形数据长度为4，占用其后四个字节。</li>
<li>64整形数据长度为8，占用其后八个字节。</li>
<li>浮点型数据长度为4，占用其后四个字节。</li>
<li>双精度型数据长度为8，占用其后8个字节。</li>
</ul>
<p>字符串，二进制和KLV类型需要使用两个字节指示数据长度。</p>
<p>数值：根据长度指示，其后指定的连续字节为数值，如果是整形和浮点型，统一采用网络字节序。</p>
<p>KLV最短长度为2个字节。</p>
<p>多个KLV打包的结构示意图如下：</p>
<p><img alt="device_KLV2.png" src="../../pic/features/device_KLV2.png" /></p>
<h2 id="_32">设备侧使用说明</h2>
<p>设备需要预先知道各个key的真实含义，比如key 123代表温度。</p>
<p>设备获取各个key对应的value，其value的含义由设备开发者定义。KLV中携带了value的数据类型。对于二进制类型，需要设备开发者自行处理其含义。对于布尔型，使用8bit的数字表示，0表示false，非0值表示true。</p>
<p>如果一次请求中携带多组KLV，并且不止一组KLV需要响应这次请求，那么设备需要打包这些响应，组成KLVs一次回复，不能对其中的各个KLV单独回复一次。</p>
<p>设备侧SDK与云端约定一个固定的messageCode作为设备控制的消息编码，一个固定的messageCode为响应消息编码，一个固定的messageCode为上报消息编码，这些消息编码对开发者不可见。</p>
<p>设备端SDK也提供编解码接口，开发者需要编码和解码时直接调用对应的编解码接口即可。</p>
<p>设备端开发参考 <a href="../../develop_guide/device/#云端通信">开发指导-设备-云端通信</a></p>
<h2 id="udsapp">UDS/APP侧使用说明</h2>
<p>UDS和APP如果使用json，那么就需要SDK将KLV转换为json。</p>
<p>UDS和APP如果也直接使用KLV则SDK不需要做任何处理。</p>
<p>SDK提供一套独立的编码和解码接口，当开发者认为需要编码为KLV时，调用我们的接口进行编码，当开发者认为需要解码时，调用SDK中的解码接口，解码为json格式的kv。</p>
<p>开发者需要编码或者解码时，需要提供云端生成的数据点json文件，SDK按照提供的格式进行编解码。</p>
<p>在正式上线环境，数据点的变动意为着产品升级。</p>
<p>客户端开发请参考：</p>
<p><a href="../../develop_guide/android/#云端通信">开发指导-安卓-云端通信</a></p>
<p><a href="../../develop_guide/iOS/#云端通信">开发指导-iOS-云端通信</a></p>
<p><a href="../../develop_guide/wechat/#云端通信">开发指导-微信-云端通信</a></p>
<h2 id="_33">厂商管理后台的使用说明</h2>
<p>厂商管理后台在创建产品时，选择产品的数据类型KLV。一个产品只能选择一种数据类型。</p>
<p>然后在功能点设置页面，创建设备的数据点（数据点对应设备上的功能点），填写数据点的名称、标识、key值，数据类型。</p>
<ul>
<li>名称：用户自己定义的标识，不在开发中使用，在管理后台中方便区分标识的意思。</li>
<li>标识：该标识在设备和客户端开发中不会使用。在开发UDS的时候，可以用作存储的列的唯一标识。</li>
<li>key值：相当于JSON中的key，设备、云端、客户端开发中都会用到。是产品功能点的唯一标识，不能重复。</li>
<li>数据类型：标识该key对应的数据类型。支持bool、int8、int16、int32、int64、float、double float、string、binary格式。目前还不支持数组。如果要使用数组，可以将该数据点定义为binary格式。</li>
</ul>
<p>数据点对应设备上的功能点。数据包对应设备和云端通信的通信包，一个数据包可以包括一个或者多个数据点。</p>
<p>在数据点和数据包页面可以导出创建的数据点</p>
<p>如果某些KLV存在关联，需要打包处理，可以使用KLV嵌套的方式将关联的KLV打包在一个KLV中，即KLV的value是KLVS。</p>
<h2 id="_34">云端消息解析</h2>
<p>在管理后台定义好数据点之后，云端就可以根据定义的数据点解析数据。</p>
<p>如果不开发UDS，不需要关系此部分。如果需要开发UDS，参考<a href="../../develop_guide/cloud/">开发指导-云端服务</a></p>
<h1 id="json">JSON</h1>
<p>JSON(JavaScript Object Notation) 是一种轻量级的数据交换格式。 它采用完全独立于语言的文本格式，但是也使用了类似于C语言家族的习惯（包括C, C++, C#, Java, JavaScript, Perl, Python等）。</p>
<p>Ablecloud规定UDS/APP与设备通信使用简单json格式，即value支持的类型有：布尔、整形、浮点形、字符串、数组，字符串采用UTF-8编码，且不支持对象。举例说明，一条合法格式的控制指令：
{
“key1”: true,
“key2”: 31.5,
“key3”: 18,
“key4”: ”hello world”,
“key5”: [1,2,3,4],
}</p>
<p>非法格式的控制指令：
{
“key1”: true,
“key2”: 31.5,
“key3”: 18,
“key4”: ”hello world”,
“key5”: [1,2,3,4],
“key6”: {“key7”:11, “key8”:”error”},
}</p>
<h3 id="_35">厂商管理后台使用说明</h3>
<p>厂商管理后台在创建产品时，选择产品的数据类型JSON。一个产品只能选择一种数据类型。</p>
<p>然后在功能点设置页面，创建设备的数据点（数据点对应设备上的功能点），填写数据点的名称、标识、数据类型。</p>
<ul>
<li>名称：用户自己定义的标识，不在开发中使用，在管理后台中方便区分标识的意思。</li>
<li>标识：JSON中的key，设备、云端、客户端开发中都会用到。是产品功能点的唯一标识，不能重复。</li>
<li>数据类型：标识该key对应的数据类型。支持bool、int8、int16、int32、int64、float、double float、string、binary格式。目前还不支持数组。如果要使用数组，可以将该数据点定义为binary格式。</li>
</ul>
<p>数据点对应设备上的功能点。数据包对应设备和云端通信的通信包，一个数据包可以包括一个或者多个数据点。</p>
<p>在数据点和数据包页面可以导出创建的数据点</p>
<p>设备端开发请参考：</p>
<p><a href="../../develop_guide/device/#云端通信">开发指导-设备-云端通信</a></p>
<p>客户端使用说明请参考：</p>
<p><a href="../../develop_guide/android/#云端通信">开发指导-安卓-云端通信</a></p>
<p><a href="../../develop_guide/iOS/#云端通信">开发指导-iOS-云端通信</a></p>
<p><a href="../../develop_guide/wechat/#云端通信">开发指导-微信-云端通信</a></p></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <div class="clear footer">
                &copy;2015&nbsp;&nbsp;北京智云奇点科技有限公司&nbsp;&nbsp;<a href="http://www.miit.gov.cn/" target="_blank">京ICP备14010946号-1</a>
            </div>
        </footer>

        <script type="text/javascript" src="../../js/jquery-1.10.2.min.js"></script>
        <script type="text/javascript" src="../../js/bootstrap.min.js"></script>
        <script type="text/javascript" src="../../js/highlight.pack.js"></script>
        <script type="text/javascript" src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
